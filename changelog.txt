20230329
主要工作是把气压传感器调节为100hz，只有寻找最合适的参数，发现电压对调节参数有影响，增加电压调节因子。
100hz的好处是调节力度更均匀，但坏处是数据噪音变得大了。

20230331
完善100hz高度调节，放弃纯气压，引入加速度的长范围均值做阻尼，目前看总体效果较好，高度波动范围不大。
还需要精细调节到最小波动。

20230405
目前主要用50hz,表现较好，波动较小，今天还测了遥控，高度比较稳定。

20230410
今日外出测试了。遥控表现可以，最后平稳落地。问题是手工推高了几次，似乎都会掉回来。另外对推高似乎反应不是很快。
水平侧倾似乎可以放开的大一点，这个版本限制在4.5度，似乎是小了点。

20230414
准备对高度调节进行修改，根据倾角主动计算总推力。

20230421
新增依靠GPS进行航向角的判断，简单测试了，部分有效。准备修改。

20230504
晚上做了测试，似乎显示飞机后来不受控制，可能是机身没有校准，yaw角漂移过大，没有观察到机头方向漂移。
又或者是遥控信号丢失导致失控。期间修改了许多代码，包括遥控器那边还整体修改了，添加了显示屏，
需要找到问题在哪，做个代码备份，标记代码有问题。

20230521
新入手的tof模块基本处理好了，包括修改了定高和光流定点。

20230523
今测试不成功，发现上一个备份的遥控部分代码有问题，没有正确处理yaw偏转。已修正。

20230527
解决了遥控器端代码问题，之前遥控器卡死导致飞机失控，是因为处理消息不正确，暂时关闭了回传消息的处理就好了。
但是也因此没有了飞机端的数据显示。之后需要修正。

20230611
从外面测试回来做了个备份，光流控制仍有问题。

20230615
目前光流控制基本可以定点，但有摇摆问题，会在小范围来回。今天进行了几次长时间飞行。最长13分钟。

20230625
GPS定点基本可用，依赖于指南针和IMU. 指南针在最初找到正北后，剩余的交给IMU。imu需要比较精准，漂移少。

20230627
今天写了磁偏角计算代码，因为所有GPS都不传送磁偏角，所以自己计算。
晚上测试了GPS定点，总体不错。3米左右漂移。

20230628
发现严重问题，存放在imu_queue里yaw角度做简单平均会有问题，在180度附近的角一平均可能就到0度了，这可能会导致机身失控。
目前是在寻找北方时旋转机身会遇到，但不是每次都发生，只要发生这个问题，机身就失控，无响应。微任务平衡算法控制里长期采用
imu平均值,但因为不常旋转，所以问题没有暴露。

20230629
新写的GPS定点代码效果非常好，备份。

20230701
新增一键返航，脱联返航测试基本通过。

20230718
这期间各方面都有微调，比如平衡函数，控高函数，遥杆范围，侧倾角度范围，指南针处理，光流稳定，GPS定点等等。
总体运行平稳，备份一个。

20230721
基本解决了稳定性问题，出在C++上的std::string，它做缓存不合适，会导致内存碎片。
优化了光流定点参数，现在似乎更稳定了。

20230724
新版的GPS定点表现非常理想。备份。另外修正了光流定位的一个错误。

20230725
中高空测试显示气压控高打杆反应略慢。一键返回速度略慢。侧飞掉高略大。

20230729
这两天重点调节了掉高问题，推高速度很快时，突然放开摇杆归0，容易导致上冲然后掉高。通过调节参数来缓和这个问题。
另外一键返回现在速度比较合理，运行也基本正常了。

20230805
这个版本一键返回已经很不错了。今天测试了。高度控制也还行。稳定度也还行。备份。

20230815
昨日在草原测试一公里往返，正常返回，大约5-6分钟时间。备份。

20230816
增加对指南针的z轴读数处理，指南应该会更精准。

20230821
在新组装的定制机上发生了空中校准指南针卡死的问题，不确定问题原因，修改了相关代码。
新增了GPS高度对气压高度控制的调节，以保持长期高度稳定。
修改了地面指南针校准代码，以适应不同的倾角。

20230828
近期主要优化GPS定点悬停，和自动航行。取消了原来的速度角度旋转的判断方法。采用速度和位置到锚定点的夹角的判断方法。
测试效果比较好。备份。

20230905
将控高的vspeed修改为一个整数，原来是浮点数。

20230907
加强倾角调节的Kp参数，希望高速降落时更稳定。在调节指南方向时，引入速度因素，速度快调节快。

20230909
增加了tof控高里的加速度调节项，放松了加减里限制，希望近地面时速度能控制的更好更准，这样降落更安全。
修改了GPS定点里的速度矩调节，区分了引力点和排斥点的不同调节，原来不区分引力点和斥力点的调节方式有问题。
重新打开了速度矩的调节，现在两种调节并行使用，速度方向变化的调节和速度矩的调节。

20230916
最近修改了通信模块，现在计划采用自行设计的通信模组，于是飞控修改较大，飞控原来的通信模块位置新增了指南针hmc5883，这样飞控代码也需要调整，会比较大，所以这里备份，这个备份仍旧使用E34双工模块做通信。遥控器也改用新的通信模组，所以也重新设计了。同时做备份。

20230926
今日测试多次100米/200米往返，来回都比较稳定，只是因为调高了阻尼，速度上升起来比较慢。备份。新测试基于新的通信模块和新的q380机架。

20231001
今日测试了长距离飞行，南500米到北500米的距离1公里的往返，总共飞行9公里。稳定自动降落。备份。

20231002
今日基于此代码飞丢，修改了气压高度控制代码，后高度不受控制上升，做个备份留作记录。准备找到原因后恢复到上一个备份。

20231011
第一次测试dshot300电调协议，满电到11v跑了近35分钟。没有发现问题。

20231013
昨日测试400米方圈后又测试了2公里往返，基本没问题，但速度偏低，只有9米多。
今日新增定时函数来处理电源数据读取。已经测试，效果还行。自动垂直爬升也测试了。定点飞行前两天测试了，然后为了快速飞行做了轻微改动，这个还没有测试，估计问题不大，做个备份。

20231017
带摄像头测试1公里往返，爬高100米，9公里全程，1公里单程大概2分钟，全程测试时间20分钟，电压掉至12v一下，手动返航，基本没有问题。
第二次用新电池测试时，遇到地磁异常，定位不稳，没有继续测。说明指南针偏离太大系统暂时还不能及时纠正。
期间尝试修改落地的姿态，避免突然停桨，但没有成功，回退了部分修改。备份。

20231025
白天测试4000米往返正常，夜间测试4400米往返正常。总体稳定。备份。目前主要问题是速度不如预期，倾角利用不充分，线路弯曲较大。

20231028
新增天空端回传位置的加密防止信息泄露。经纬度及高度，其他不加密。

20231029
做了长距离4.5公里往返测试，效果理想。前两天调节指南的算法有点问题，已经纠正。目前的线路稍有S型摆动，问题不大。

20231101
昨晚做了4.5公里往返测试，路线非常直。这方面的调节基本到位。近两天还调节了tof控高问题，之前向上打杆立即放松则下坠明显，现在好些了。

20231105
昨天分别测试两架飞机，一架往返5公里正常，另一架2.5公里方块在第一段的末尾出现问题，估计是坠机了。可能是失去平衡。
原因可能是桨叶脱离，大风，有雨等，当时可能穿入乌云中。桨叶问题此机器发生多次都是落地时，四合一刹车太猛。
此版本相对上个版本改动不大。

20231113
测试发现无线模块可能会受干扰后完全中断且无法恢复，可能是代码的问题。

20231114
今天改动了通信，地到天的遥控信号做了加密，并且调整了发送方式。一部分功能转移到了通信板上。遥控器现在只是收集数据传给通信板，
通信板负责加密发送，发送频率由通信速度决定。这样三个部分都做了调整，通信板代码/遥控器代码/飞控都做了修改。尚未充分测试，备份一个。

20231117
这几天修改通信，天到地的传送链做了全面改动，通信板现在是非透明模式，承担了主动发送数据和数据加密的功能。
飞控发往通信板裸数据，有包边界和校验码，以防止通信中断后无法恢复。通信板在合适时机发送数据到地面板。空中所有数据加密。
简单测试后没有发现问题。由于是全盘改动，整体备份。

20231118
飞控板推送通信板方式做了修改，改为使用定时器。这样其他地方就不用关心信息推送问题。
通信板在不能接收到飞控推送时，或是数据校验失败时，自主发出数据中断/数据错误通知到地面，地面可感知无线干扰问题。
修改了通信加密表，256*16数据阵列，双向共用。
之前发现定时器回传飞控数据出现问题，导致飞机无端快速上升，现在取消了这个方法，依旧沿用老方法，测试基本没问题。备份。
下一步，准备修改遥控器的按钮，按钮信息保留在遥控器本地使用，在安排任务时，发送任务命令，平行于摇杆命令。

20231121
近几天测试了修改后的遥控的稳定性，基本问题不大。测试了排除TOF设备的飞行控高，也可以飞，只是起飞时似乎增力偏慢。后来调节了增力的速度，但没有测试。
准备在这里做一个备份，然后把遥控的按钮功能修改为本地使用，任务安排由遥控单独发任务指令。

20231123
这两天进行遥控体系改动，遥控器按钮原先直接对应了任务功能，作为信息发往飞控，现在所有按钮功能都保留在遥控器本地
将按钮的动作变成任务命令发往飞控，这样命令可以从遥控端更新，增加一个新的任务不必去修改飞控。修改涉及全部方面的代码，
还没有全部完成。另外摇杆数据的发送频率做了调整，摇杆有变化时立即发送，无变化时，随着无变化的时间拉长，发送数据变慢。这
主要是为了防止遥控接收飞控的数据干扰，本地不发送数据则接收干扰应该较小。

20231128
改动平衡代码，之前是高度优先，现在为改平衡优先，在两者冲突时，保证平衡放弃高度，这样可能更稳定。倾角限制综合了pitch/roll的情况，不单独限制某个倾角而是综合考虑。落地停机检测增加了一些判断。tof控高有微调。测试基本没问题。

20231129
昨晚有个长距测试，今天有个大风中测试，看起来没问题。今天修改了遥控中的空中计时。微调了定点控制的力度。测试没什么问题。备份。

20231130
现已确认，之前备份的版本里，纯气压降落的判断在大风中存在问题，会导致误判关机坠落。

20231204
修正气压降落的误判问题。修改了平衡函数里的调节方式，从之前的以平衡为首高度其次的调节改变为平衡调节可在一定范围内借用
高度控制的力度，以增强平衡力的方法。修改了气压控高里的速度计算方式，导致垂直速度跟不上设定。
当日再度修改气压控高，飞丢一架。

20231215
因久未备份，做一个。近期主要在调节气压控高，使高度控制更稳定，先后基于10月分的稳定版调节了多次，表现好的标记为good1,good2
目前还在细微调节中。计划调节好以后把10月份的稳定版替换掉。期间为了测试的稳定性，增加了高度控制切换功能，测试版只能在较低
高度飞行测试，更高的地方自动切换到稳定版本，这样做确实起到了防止再次飞丢的效果。

20231218
昨日用最新控高代码取代早期稳定代码，表现稳定，顺便还做了录像。备份。

20231227
前天飞丢一架，带摄像头，为第五架损失的飞机。当时起飞后发出自定义任务B;H100;E100;H100;S100;
爬高100米没有问题，东飞100米也是没问题，再次爬高100米在后半程就看不大清楚了。再往后，是否完全执行了南飞100米不清楚。
在等待的过程中，目视完全无法看到飞机，等待较长时间后，发现低空中飞机高速掠过。速度近20米，电量不太够，于是发送返航指令
但随即丢失回传信号，估计已坠落。后查问题，应该是摇杆漂移造成的无意识接管。之前只发现控高摇杆漂移，下来后发现方向摇杆
有更严重漂移。已经替换了摇杆，修改了接管代码，接管要求更严格。

20240103
组一台新机，电池上置。然后修改代码，减小日志记录的占用空间，怀疑日志占用太高会导致不稳定。新机看起来没问题。

20240106
修改了气压控高里的imuacc计算范围，缩小了这个计算范围。
修改了gps_stable里的刹车算法，把imuacc也修改为调节项。需要测试。

20240107
这两天调试GPS刹车，定点，移动三个函数。做了修改。

20240108
测试表现很好，水平位置调节很快到位，不回飘，如预期一样准确。
只是返航降落仍旧有不关机问题。可能是雪地测距因素，需要解决。
备份。

20240109
增加对GPS信号的分析，根据定位信号质量，调节水平定位的调节力度及调节上限，涉及三个定位函数。
将pin_to_location角度计算限制到25度，执行限制到23度。等同于gps_position_adjust
倾角太大了耗电凶猛，不太经济。
pin_to_location里增加电流限制，以抑制电流过大。

20240113
清理掉大批不使用的代码，包括老的坏代码和老的好代码。以后如需参考需要找之前的备份。

20240123
前天大风中飞丢新造的一架机器，4节电池上置。总体来说没有问题，主要是风力过大，定位不能维持，自主返航不能抵抗风力。

修改气压控高和测距控高里参考imu的数据范围，原来由50个改为25个后感觉波动较大，现在修改为100个数据，即0.2秒。
修改平衡算法里的远离阻尼，原来是单向20度后增加远离阻尼，现在修改为整体30度倾斜后增加远离阻尼抑制大幅侧倾。并且放松输入的期望角度，由整体限制25度倾斜，放松到整体30度倾斜。
三个关于GPS的定点/移动函数里(pin_to_location，gps_position_adjust, gps_position_stable)，关于Imu水平加速度的参考范围由50个调整为100个。应该会更平滑些。
放开三大定点函数的角度限制到28度。之前的pin_to_location限制是23度，另两个是25度。风力大时不够用。
pin_to_location里电流限制由原来的8安，放松到12安，超过12安，且角度>15度时，会适度减小角度以节省电力。

20240128
今天想清楚了上次为什么飞丢的问题，当时风大，高度控制不稳定，一直往高飞。之前一直认为是摇杆漂移。实际是平衡借高导致的高度方向上的控制问题。风大导致平衡吃紧，于是借高，借高掉高，导致高度算法不断加力上去，于是越飞越高。
如果需要保留借高算法去提高平衡性，那么控高算法不能基于其早期抛出的推力，而应该基于实际执行的推力。
今天测试6电池飞机，也是一起风就差点飞高飘走，问题的根子在平衡算法的借高上面。6电池飞机起飞油门大约47.5%，能够用于平衡调节的空间有限。借高力度太大很容易在高度上失控。

20240130
tof控高修改的不好，恢复到之前版本。保留平衡借高算法，测试基本稳定。备份。

大幅度改动，由于垂直推力可以被平衡修正，之前的改动是把修正后的值放在推力序列里，现在调整了，放在motor_ctrl里，然后控高从那边取参考推力数据。平衡函数的参数也变了，不需要输入参考推力，内部自取，输出增加一个垂直推力，然后被输送给motor_ctrl，记录并供控高参考。
今日已测试，新修改的控高逻辑没有明显问题，似乎还挺好。备份。下一步测试气压控高然后修改气压控高稳定版。

20240131
测试了tof控高对imu加速度的依赖性，降低到一定程度就不能再降了，否则会引起高度的扩散震荡。
尝试寻找垂直推力的参考值的延迟量。延迟20，30毫秒都测试了，似乎30毫秒更合适，未来还可以尝试向前推。
balance里的kp值稍微放大，增加灵活性。wi1的距离拉大到10个数据，以更准去的评估角加速度。加速度阻尼参数似乎调大了会导致剧烈抖动，所以现在调的比较保守。平衡借高再次缩小范围到0.95-1.05之内。

20240201
由于在非正X机架上抖动控制的不好，抖动容易导致高度失控，于是新做了一个函数用来分析和过滤imu垂直方向的抖动，用于控高。需要测试。

20240204
非正X机架电池上置，四节纵向布置依旧抖动严重，电机换下了一个平衡很差的，依旧抖动，换成正X机架还是抖动。怀疑板子太薄了，电池悬挑太大。总之换了几个设计依旧不能减小抖动。好在可以控制降落。
目前有个小问题是，在气压控高和测距控高之间，大概5-8米高的时候，高度会突然降低下来。落会测距控高范围，怀疑过渡存在一定问题。也许是两者共用了参考推力，而之前是分开考虑的。

20240206
修改了tof控高，之前是有一个或两个有效测距时，在速度较快时会抢控高，现在只抛出推力数据，不抢控高，有三个测距数据才抢。
简单测试没问题。
修改了落地检测，之前测试中，自动降落还是反应有点慢，不及时关机会导致侧倾，这是GPS水平位置保持决定的。所以自动降落要能及时关机。除了这个修改外，其他最近修改的代码都测试过了。
晚间修改Pin_to_location的电流限制代码，新定义了几个数据CURRENT_CARE,CURRENT_WARN, CURRENT_HIGH，控制会更好，还没有测试。

20240208
发现自动落地无法停机不在测距上，而是遥控接管不当。修正。已测试。
下一步，GPS水平定位的参考倾角目前是从控制系统自身记录提取，将来可以用实际执行的倾角记录，应该能够更好的稳定位置。
命令和执行之间存在时间差。

20240217
返京，外地测试飞高1200米无问题，发现一个小问题，就是gps定位完成的情况下，如果矫正指南针，则完成后会自动起飞。已定位修正。另一问题是气压控高似乎阻尼不够，速度大幅变化时，上下抖动大，要么降低对于速度的匹配，要么增加阻尼。现在将spd_dif做sigmoid变化，以降低速度匹配。将气压阻尼由pr0-pr1调节为pr0-pr2,拉大时间差，并放松差值限制到上下5.0，这样阻尼调节会增强。备份。但以上改动还需要测试。

微调定点降落速度，最大速度放开到8米/秒，新增独立函数计算合适的降落速度。
微调速度信度。统一到一个函数处理。
关于GPS信号中断和恢复的日志稍有修改，在连续信号中断时取消连续日志记录。外地测试曾经记录到信号中断了9秒。一个奇怪的情况，可能是干扰。
以上改动还需要测试。

20240218
新增gps_dist_reliable统一处理距离信度。

20240219
修改自动调节高度的任务，增大了上下速度。定点降落时速度调节加大了。这部分没有测试。
取消了GPS刹车的修改，在imu加速度里加入调节。低速刹车测试了还行。但大速度刹车没测试。

20240220
目前的代码在电池上置的机器上表现比较稳定，但回到电池下置的机身后，控高不行，高度上的波动极大。
这有可能是后者的机械强度偏弱导致机身抖动较大有关。也可能是参数调节不到位。
做个备份，然后准备为后者调节合适的参数。

20240222
近几天针对电池下置的机架调试控高代码有点失败，可能和这个机架的震动较大有关，极难稳定。放弃调节，将两个控高函数还原为20240217版本，使用电池上置机器去测试。电池下置机架可能需要重新制作。因为机臂损坏而且机架偏软了。

20240223
新增气压高度控制的刹车功能。仅限遥控器方面过来的控高突变信号。在遥控信号接收过程上根据信号变化标记刹车。
在自动控制的位置是不做标记的。测试表现良好。气压微分调节增加了一点，灵活性减小，稳定性增加。备份。
微调GPS距离可信度。微调速度信度。未测试。

20240224
微调高度控制的刹车功能。连带这两天的修改一起测试了，基本没问题，水平定点较稳定。气压悬停时有可见波动，上下大概0.3米，需要改进。
然后在气压控高垂直向下的速度较大时放松摇杆，之后上下震荡非常大。需要改进。像是阻尼不足。
放宽气压控高里的气压加速度差异调节项的限制范围，将期望加速度混入Imu加速度做调节，以更好的控制加速度。

20240225
今天主要修改气压控高，现在基本稳定。备份。

20240226
起飞时清除GPS锚定，可避免起飞即锚定上次的位置。
新的控高函数现在返回落地标记，函数名称尾部增加_with_landing_detect，可避免后期落地检查，简单测试过了没问题。目前只有tof控高会返回落地标记，气压控高不返回，气压控高不落地。将来需要完善在气压控高里检测落地。这个较难处理，可能导致空中关机。

气压控高里增加侧翻平滑关机以保护硬件。
tof控高里增加侧翻平滑关机以保护硬件。

20240228
自1月23日大风中飞丢以来，先后设计并制造的几个测试机都因为抖动问题而修改设计。一个主要因素是飞控使用了42688芯片，这个芯片的滤波设置和42605不同，所以导致了机身抖动，控高不稳，平衡较差。之前一直怀疑是电机质量差，抖动严重。不断调整机架设计和参数，都不能使其稳定。先后炸掉若干桨叶。今天才发现问题。起因是把42688飞控换装到一台确定稳定的机器上表现的不稳定。至此才发现是飞控问题，怀疑当前的42688损坏。然后准备换一个42688芯片，等拆下来后，发现电路板布线在拆焊时损坏，需要重新做板。做板过程中突然想到去对比42688的差异性，才发现是滤波参数不同。于是板子做好后，针对42688芯片修改了滤波参数，重新刷了新代码，然后测试表现稳定。飞丢的那台和这个滤波有很大关系，影响到控高，使得高度不断上升无法控制。不过当时的风大，以当时设置也不能抗住那么大的风。
修改定点降落的降落速度函数。之前短距离测试下，立即就开始降落，这不是所期望的。

20240229
高空中，一个偶发的错误测距数据可能导致进入平滑降落状态，随后测距失效，转入气压控高继续执行平滑降落，然后停机坠落。
现已在气压控高中加入防范代码，tof引发的进入平滑降落，必须由tof控高全程执行，气压控高接管即失效。得到了这个经验的炸机代价是损失4个桨叶，3个机臂，维修后首次正常起飞，期间电机异响，降落后再次起飞时左前电机已经不动了，可能是电机损坏，也可能是电调损坏，还需要检查。目前42688的飞控反而比42605的更平稳，当然机架也是前者更成熟，后者机架是新做的，可能存在问题。

在平衡算法里，原来用来计算角加速度的是当前角速度-10个数据前的角加速度，现在，采用5个数据差的平均值以减少噪音。需要测试。

20240301 
昨日角加速度修改已测试无问题。现在平衡控高都比较稳定，今天大风中飞行也还行。只是最后刹车段弧线严重。所以新增一个调节_heading_yaw的办法，期望在大风中会有改善。
修改电流电压采样频率，使pin_to_location能更好的调节电流消耗，之前100毫秒一次延迟比较大。
新增一个_heading_yaw调节的新办法，利用推力变化方向和速度变化方向的匹配去调整，可以用于加速和减速中。已经在三大函数中加入，需要测试。


20240302
计划修改_heading_yaw的调节。昨天已经写了一部分代码放进了三大函数里，但还没有测试，今天计划更多的修改。所以备份一个。这里面包含了未测试的_heading_yaw调节代码。本备份不可做稳定版使用。

大幅修改仅根据平均方向变化调节_heading_yaw.

20240303
测试了修改后的_heading_yaw调节方法，看起来是稳定的。但目前电流控制追不上姿态控制。这部分需要调整。备份。
修改pin_to_location里的限流方法。需要测试。
微调gps刹车，避免二次读取Imu数据。微调锚定的条件。
在pin_to_location里关闭机头随动，因为不利于拍照。
pin_to_location里电流限制修改为功率限制，气压控高也一同修改。

20240304
增加水平移动的掉头。超过20米距离的会掉头指向目标点，到达后会再次掉头指向出发点。功能在微任务里实现。宏任务不处理。
删除micro_task.gps_last_anchor_tmark，作用不大。新增micro_task.turn_head_mark标记，用来处理到达后掉头。
gps_stable里增加GPS测量加速度阻尼项。

修改了_heading_yaw调节方法，仅保留航向角调节和方向变化调节。应该不用考虑加速段和减速段了。

今日有一次奇怪的炸鸡，起飞，升高30米，然后前飞50米，抵达后悬停几秒后姿态失稳坠机。情况看起来像是电机故障，也有可能是内存碎片引起的系统崩溃。电机拿回来重新装好后似乎是正常的。

清理掉不带降落检测的老的控高函数。因当前的基本稳定了。 

20240306
昨日增加了gps_stable微调，今日小场地测试看起来稳定。将来考虑将gps_adjust合并，看起来没必要单独做一个刹车函数。有几天没有备份，备份一个。
轻微修改了陀螺仪的滤波，取消了陷波滤波，似乎无影响。减小了陀螺仪滤波带宽，可能带来更多延迟，于是轻微加强平衡调节参数。目前还有轻微摇晃。gps_stable微调作用不明显，虽然没有稳定问题，但还是存在超调，像是回正速度偏低，总体问题不大。
42688陀螺仪温飘确实大，温度轻微变化似乎影响很大。高温下校准的imu，转低温下yaw角负向漂移。校准后再起飞方向稳定性较好。

20240307
今日大风，去外场测试，前飞100米后炸鸡，情况和3/4的炸鸡一样，自动任务正常完成，转为遥控控制时炸鸡，这可能是GPS_STABLE里的微调导致的！
从pin_to_location接管而来的GPS定点，首先进入刹车状态，随后会进入微调，微调需要的参数没有在pin_to_location里填写，这样计算可能导致混乱？

20240308
暂时取消gps_stable里的微调，感觉会带来稳定问题。然后检查了自动飞行任务后的接管问题。多次测试似乎没有问题。1公里往返也安全返回。但是自动落地似乎被遥控接管而没有停机。这里需要再测试。然后功率限制稍差，所以增加了功率加速度调节，希望功率调节更平稳。调低三个阶段的功耗各10瓦，因感觉最低档的100瓦警告功耗已经可以飞到13米/s，电流大了电池的功率损耗很大，要适当限制，90瓦做警告功率估计够用，经济飞行10m/s可以了。
几档功率限制需要根据自重和载重来调节，如果机器有载重或重量较大，则功率要相应调节增大。限制功耗是为了保护电池，避免电流过大。而速度上限放的很大是因为有时可以借用风力去执行更快的飞行速度。在速度上限没有达到时，主要靠功率来限制速度。悬停功耗120%-130%做警告功耗比较合适。
备份一个。这个版本的主要问题是自动降落不停机，可能是被遥控优先接管了，这两天这里有改动，不知道哪里改错了。需要检查。
修改定点飞行的误差传递路径，之前没传到执行者，一直用的是固定值。
balance里增加角速度调节项，需要测试。

20240309
今日已解决所有已知问题，包括自动降落不停机，balance里新增的角速度调节项测试，包括42605/42688两个imu的调试都基本解决。还测试了新的tmotor 2207v3 kv1750的电机。带9047桨叶悬停电流很大，在7-8安，油门很低，在0.8，换了7040三叶桨后，电流6.2左右，油门1.1-1.2左右，悬停时间最多35分钟。不过振动小，操作灵活。带相机拍照也不错。针对这个配置的机器需要修改功率限制，之前的功率限制是针对2308的，显然对这个不合适。这个电机和桨叶的配置效率较低，不适合远航。除此外，代码适合两架机器的运行，已没有明显问题。做个备份。

20240310
下午飞丢久经考验的老机器，掉在河里了。原因可能有三点，一是电机问题，有电机摔过，磁钢似乎松动，没仔细查；二是螺旋桨松动，飞前没检查，三就是功率限制算法可能有问题导致了整机功率下降到不合理水平。具体待查源码。倾向于硬件问题。最后数据显示每秒17米的速度掉高，姿态严重破坏，pitch=-35,roll=-47, 电机功率很低，电流很低，电压正常。这似乎是激发了平衡算法里的倾角过大保护，从而失去向上的推力。20241031补记，很可能是主控供电波动造成。

20240311
取消盲目起飞支持。微调气压控高里的速度阻尼，稍作减小，使得速度匹配能更快些。

20240313
9日坠机的原因很可能是硬件问题。此机之前有两次奇怪的坠机，发生在自动任务完成后不久，即遥控接管后不久，当时以为是接管过程存在问题还检查和修改了代码。两次坠机都掉在土地上，也很可能造成电机损伤。大概率是因为电机损伤导致失步，失去平衡而坠机。
微调GPS刹车中的加速度上限，之前是个固定值，会导致震荡，现在修改为一个根据速度改变的值。速度大时更激进的减速，速度小时，平缓减速。需要测试。

20240315
在平衡函数里增加角加速度调节项，角速度调节项，适度降低角速度阻尼，增加了灵活性。测试表现还好。
备份。遥控器里新增加本地GPS位置更新时，刷新距离显示。在飞机失联时可以方便定位。
修正气压控高稳定版里的功率限制。之前没起作用。
继续打压气压控高的速度阻尼，之前的调节系数1.02-flex修改为1.0-flex，降低残余阻尼，因速度控制长时间不能匹配到遥控的要求。
修改遥控器的高度控制系数，原来是控制在3.2m/s，现在放松到4.8m/s的范围。

20240318
准备在数据传输中引入crc校验，之前多数都是用的异或校验码，然后无线传输依赖Lora自身的crc校验来确保内容完整性。但是如果收到了干扰信号，其crc本身也是没有问题的，然后可能产生数据误接收的问题。考虑到安全性，发送到天空端的摇杆信息要增加独立的crc校验，而任务串则将异或校验修改为crc校验。
在这次修改前做个全备份。

分步骤完成修改，
1.遥控数据包传递给遥控端的通信板时的数据校验修改为crc.
	1.1 预定义命令发送的crc校验码，扩展为全包4个字节校验。
	1.2 任务串的发送修改为crc校验码，扩展为校验码之前的所有内容。
	1.3 摇杆数据修改为crc校验码，全包，排除crc本身。
	以上所有修改都在stick_info_collect()里。
2.修改地面端通信板的校验检查。
	2.1 修改摇杆数据接收校验
	2.2 修改预定义命令数据接收校验
	2.3 增加任务串数据校验，之前这里没做校验。
3.地面端通信板发送给遥控器的数据之前就没有校验，暂时不动，将来可能增加校验。
如果地面端接收到了干扰数据，随后发送给遥控解析，可能遥控会显示错误信息，但不会影响飞机安全性。本次修改暂时只确保遥控发送给天空的数据正确。

4.天空端传递给飞控的校验码修改为crc.
	4.1 摇杆校验码修改。最后一个字节是crc, 前面所有字节都在校验范围。
	4.2 预定义命令修改。前4个字节都是crc范围，第5字节为crc.
	4.3 任务串修改，前面所有字节都是crc校验范围。
5.飞控接收天空端通信板的数据校验修改
	5.1 预定义命令校验修改。
	5.2 摇杆命令校验修改。
	5.3 任务串命令校验修改。
6.摇杆数据发送增加校验码，之前依赖于lora自身的crc校验，接收到的数据包虽然完整可靠，但可能是别人的，如果恰好出现碰撞可能造成误操作。校验码放在最后，覆盖除自身外的其他内容（含头部的加密码），然后被加密码加密。
	6.1 修改地面通信板的发送数据，增加一个校验码。
	全0包之前发送2字节，现在发送3字节。
	全包之前发送6字节，现在发送7字节。

7.天空端通信板对摇杆数据新增的crc字节解析调整
8.地面端通信板预定义任务发送时，增加crc校验
9.天空端解析预定义任务，增加crc校验处理

	简单的测试，预定义命令没有问题，字符串任务也没有问题（不涉及到这部分改动），摇杆数据没有问题。


20240320
完成了坐标计算函数global_dist_angle_to_gps，基于某个坐标，朝向某个方向行进某距离得到目标坐标。这个函数之前一直采用简化算法，只能算局部。新方法可算大跨度的全球坐标。
并且反过来计算两点之间的角度和距离global_gps_dist_angle也可以匹配。
help_landing标记不用来做降落判定，取消。
LT降落到出发点修改为LH, 新增RH返回出发点，但不降落。
完善带海拔高度的G命令，处理高度变化的移动问题。

20240321
修改了H命令和A命令，因为要支持高度调节时机身旋转，所以至少2个参数，这样这两个命令要带括号。
自动下降时，在接近目标高度时，速度有点慢，调高点。
测试了新的A命令和H命令，看起来没问题。

20240323
修改通信板的代码，主要是天空端，也顺便轻微修改了地面端。天空端的发送代码存在盲等行为，即发送数据包后等待完成的中断信号，然后继续发送下一个。这样，如果刚好丢失了中断信号，则整个系统都在盲等完成信号，会导致数据发不出来。偶尔可能会出现丢失中断信号的情况，为避免这种情况，采取了主动措施来纠正，如果发出去的数据包在一定时间内没有收到发送完成的信号，则主动标记发送完成。
地面端之前就有这方面的处理，天空端则没有，现在加上。修改了sending_mark，之前是bool变量，现在是uint32_t变量，记录了发送时间。经过检查，是硬件问题。通信版SCK线没做好，飞线后正常，但软件的修改也没有问题。


20240324
微调heading_yaw更新，主要是避免逆风飞行时的S型路线。
新机悬停测试时间39.5分钟。全重762克。kv1350, 8寸双叶桨。kv值对于悬停时间影响极大。
自动任务时，新增气压记录，用来对比GPS高度。
微调控高里的GPS高度调节，一秒调节一次。期望在水平飞行时更快的适应气压变化。不含稳定版。
测试后更新到稳定版控高里。

20240325
今天双机拉锯测试，满意，备份。
yawspeed调节系数微改，最大速度微改。

20240326
昨晚飞丢一架，2.4公里往返，返程到距离500米重启。大概率是供电模块进水重启。低温潮湿天气。电路板和供电模块需要防水处理。

20240327
由于平飞中的功率控制不算太理想，不平滑，功率抑制滞后，有时也会达到超高功率，所以需要适当修改。

20240329
heading_yaw的更新可能存在边缘问题，今天在测试电池续航时，保持悬停。突然在26分钟后出现位置维持不稳，大幅度绕圈。手工接管落地。这可能是heading_yaw的更新可能存在问题。需要检查代码。
这个问题在之前的测试中没有遇到过。但是和雪天丢失的那架带摄像头的机器的症状有点像。似乎也是在悬停时出现了不可控的顺时针绕圈。
怀疑和yaw角的大幅漂移也有一定关联。需要考虑yaw的漂移速度很大时，是否会影响定点的稳定。yaw漂移超过一定范围会引发问题吗？

经过检查没有发现问题。但如果GPS传感器传递了错误的方向，则可能造成问题，方向应该是0-360范围，这个范围系统没有检查，如果超过了范围可能会导致更新出现突然的大变化。为了避免去检查可能的偶发错误方向数据，将每次更新的范围再度缩小，这样即使出现了一两个错误的数据也不会造成大问题。

需要再次测试，不校准，放任yaw角大幅漂移超过180度，观察是否能重复这个问题。

微调heading-yaw更新方法。

20240403
备份。这个版本测试了许多次长距离，比较稳定可靠。

微调heading-yaw更新方法，将sr更新为sr2，因总体上sr2<sr，放大调节系数。

20240404
发现侧翻后电机发力都升到最大值，且持续不退，这和预期不符，需要检查代码。
增加heading_reliable，在gps_position_adjust gps_position_stable里，然后在调节时考虑这个因素，
这样当识别到方向不准时，调节速度会大幅降低，不易失控。heading_reliable使用加速度和速度的夹角判断。
正常情况下，加速度总是和速度方向相反的。
gps_position_adjust gps_position_stable 两个函数里增加的关于加速度和速度方向的匹配调节测试完成，总体有效，
当前以错误的角度起飞时，也不会有太大的问题，正确的角度会在绕行一圈后稳定下来。因为引入了heading_reliable，所以刹车时力度偏弱。位置稳定时的飘摆可能稍大。
增加全局变量_heading_reliable. 最初较小，随着时间增长而得到加强，然后加速度和速度的比对调节减弱，不影响刹车的力度。

20240407
电流计的比例系数放大到100，之前是80，这是大约在8安电流下的测试匹配结果，80得到的电流偏小了。同时放松三档功率限制。
为了使靠近目标点的过程更迅速，在速度计算上，dist增加5米去计算，这样在短距离下进入目标点的时间会缩短。

20240408
昨日坠机，往返5公里，实际返回到还差1.5公里时因电池失效坠机。本应有200kj的能量，在放出100kj就失效了。
主要是因为功耗没控制好，前期功耗过高，电流过大，返回时顺风，但电流还是太大，电池没有顶住。
电池用的三星50G, 以为是3C, 实际是2C, 对于2C的电池。长期放电最好压制在8A以内。

功率限制改回到电流限制，这样电压降低后，不会拉高电流。
减小Pin_to_loc里的heading_yaw调节速度，观察到在逆风飞行时，摆动较明显。这可能跟功率限制下的主动减速有关。

20240409
昨夜坠机，往返750米，返回时坠落。发现是电池座焊接存在松动问题，和头天的坠机有类似之处，可能是之前电池座就有焊接松动，
上次坠机后又没有仔细检查。重新焊接了电池座子，长时间使用过后可能会焊接松动，以后要注意。两次坠机都能找回确实不容易。
在依据速度和到目标点的夹角调节heading_yaw时，增加积分调节，期望带来稳定性，主要是长距离运动下的作用，但位置保持那里也增加了这个调整。

20240411
昨日测试1.2公里往返，在第3次时坠机，也是电力系统问题。所幸找回。
今天测试了1.2公里往返，共9次，都正常。xxd电机配9寸桨的运动性很差，平飞时高度波动大，高度的稳定性不好，这导致高度方向震荡幅度大，然后导致电流的波动很大。amax配8寸3叶虽然悬停效率不及9寸桨，但运动性好，平飞高度波动小，电流波动小。
考虑到平飞时气流对气压的影响很大，在控高函数里做出修改，利用GPS的高度数据来调节高差的频率修改为每秒2次。之前每秒一次，每次调节的跨度较大，会导致更大波动。另外xxd机架可能需要修改参考推力，在时间差上可能存在不匹配。不过最大的可能是震动，震动导致垂直方向的阻尼减弱了。
增强气压控高里的二次调节里的加速度阻尼调节项系数和速度调节项的系数。取消二次调节里的R2系数，直接改用Ratio，这是一次调节里的总系数，所以二次调节又增强了50%。之前R2=0.1 Ratio=0.15
增强二次调节的高差调节系数，速度调节系数，加速度调节系数，之前0.01*R2, 修改为0.1*Ratio
简单悬停测试未发现问题。飞行中的高度稳定性需要另外测试。因为加强了2次调节，估计高度上的波动会变小。
降低二次调节参数，因为amax机架发觉明显的电机出力抖动，易导致发热。明显是调节力度太强了。虽然是高度的波动小了，但发力波动大不是好事。现在调节项为0.05*Ratio, 阻尼项为0.1*Ratio, 在amax机身上只大不小，但在xxd机身上可能还是偏弱了。具体看下次测试。
加速度阻尼项系数调高，0.35->0.42

测试总体稳定。备份。

20240413
上午测试，amax机架在完成自动往返任务将控制权交给遥控时坠机，类似的问题在早两月前也出现过几次，当时修改过代码，但似乎还是有问题。但现在还不确定是不是电源问题，还是软件的问题。这个机架之前没有坠机，焊接问题可能不是主要原因。倾向于怀疑控制权交接处还是存在问题。

在检查软件后，确认是软件的同步问题。主线程将控制转移给遥控器并标记初始状态，但微任务可能异步修改这个状态为done, 这会导致遥控过程停止。现在遥控过程采用新的remote_done标记结束状态，和其他过程完全区分。可以避免状态同步问题。
这个问题导致的炸鸡概率可能在1/20，是个状态同步问题。之前炸过几次没搞懂原因。这个问题只发生在自动任务完成后交给遥控管理时。

因为速度变动太快导致风压变化大，高度上变动较大，不易稳定，电流波动就大，然后电流限制导致速度时快时慢。所以，为了在运动性能较低的机器上得到稳定的速度表现，限制pin_to_location里的速度差和加速度范围，之前都限制在1.0, 现在限制在0.2/0.5，这样加减速会小一点。

20240414
今日用amax机架测试了两次，确认昨日修改正常。xxd机架电容损坏没有试飞。
备份。之前的备份都存在控制权交接坠机风险。

20240416
这两天主要修改了进近时的控制算法，之前路径有明显的弯曲，可能是加速度在两个方向的独立控制不协调引起的，现在统一计算速度/加速度后再分解为两向，似乎线路更直了。需要测试。
下午测试表明，修改后的pin_to_location进入目标点的路线更直了，基本不弯曲。但在目标点附近的稳定性变得较差，这导致自动降落靠近地面时很难落下来，因为水平定位总在飘移中，范围偏大，稳定性较差。另外在接近50米左右的距离时，有明显的刹车动作，太过明显了，不平滑。
发现新修改的逻辑只关注进场和出场的速度和加速度，忽略了定点的情况。进出场似乎更丝滑，但定点的逻辑不对。需要修改。这次修改有点顾头不顾尾。
抛弃新的修改，在老的代码上重新修改，将硬性的速度和加速度限制做联合模量处理再回归到两个方向限制，这样不易引起弯折。
同时修改gps_position_adjust定点函数里的限制处理，也改为双向联合模量限制
今日简单测试没问题，没有做长距离测试。

20240418
之前的功率限制处理办法是标定一个最大水平推力限制，其后推力调节方法不动，最后校验是否超标，超标直接裁剪。这种方法不够平滑，造成速度顿挫。尝试修改调节方法，在调节方法里主动减速。修改前做个备份，目前的代码看起来是稳定的。

新方法很失败，导致风中路线大幅偏转，最后完全混乱。一种方法是恢复修改之前的版本。一种是沿着这个办法继续修改。
从日志分析看，主要是因为逆风，调节的也不够平滑，一限制速度就很快过头，速度降低到很小，然后风一吹，路径掉头了。这时候方向就出现部分问题。发现掉头后又加力反转，但功耗又上来了，然后又控制功耗迅速降低，速度又迅速降低到0，然后又被风吹掉头了。不断的加力对抗逆风，不断的超过功耗限制，然后不断的刹车掉头，是主要问题。刹车不够平滑。一刹就过头，过头再发力再受限。

取消新的调节方法，微改老的方法，增加两个调节项，希望调节更加平滑。增加指向目标的速度作为调节判断依据，不使用绝对速度。

20240419
微调get_spd_acc_lmt_by_dist，增加速度夹角，在速度夹角较大时允许更大的速度调节和加速度调节。

下午测试了，总体还可以，有一次往返百米出现超高电流。可能是航向角偏离较大限制了电流控制。 还有过冲的情况。所以在水平速度调节上做了小改，调低了速度限制。在电流限制方面，调节为30度夹角外都限制电流，之前是45度外限制电流。xxd机架首次飞行还出现了大幅摆动的不稳定因素，后换了amax机架测试，然后再测xxd就没有摆动了。上午用xxd机架还爬到过500米高，也没事。回来后重焊了电池座，似乎有虚焊问题。

垂直爬升电流限制不理想，不够快。微调，使得调节力度更大点。

20240420
微调爬升时的电流控制。也分三挡去调节。微调电流限制档位，因考虑挂狗拍摄，悬停电流比较大，适当放松飞行电流限制。
爬高限流极为有效，电流被压在了警告档位，在搭载全狗的机器上，上升速度较低，大概2-3m。可能需要对这台机器适当放开警告电流限制。或者采用第二档限流。

将水平速度在5米内做线性处理，5米外开根号处理，之前是以10米为分界限。发现线性处理的速度不好，路线容易弯。
在爬高限流时，新增条件，要求向上的速度大于4m/s才考虑限制电流。不然有些场景爬高速度特别慢不合算。

20240506
在高度控制上有个关于限流的逻辑判断错误，导致电流没有控制好，做了修正。

20240508
微调高度调节参数，避免上升速度过快冲过目标高度。
新增高度调节时，避免降落的处理。在下降触及到tof控高时，停止下降。
微调高度控制时的电流限制。

20240512
测试7公里往返，不幸电量不足，在返回时距离目标1129米耗尽电量坠机落水。主要是风力较大。水平速度只在6米左右。飞行时间27分钟。放出电量196kj. 本机正常悬停接近40分钟。

20240602
整理了代码，把可调节的参数移动到skydogge.h里。
在失去GPS信号时，不放弃标记锚定位置，这样短时间丢失信号不会导致锚定漂移。之前是放弃锚定，会导致锚定点变化。
适度调大电流控制的速度下限。
新的机架修改为采用电池包，降低重量约30克，起飞重量712克，8寸3叶悬停42分钟，9寸2叶悬停48-49分钟。
和老机架不同的是，两个主芯片换位了，旋转惯量两侧不同。
新增Parse_Task_String错误检查，解析出现错误返回-1，丢弃所有的指令，通知遥控器。
减弱平飞途中_heading_yaw的调节力度到原来的1/5，因为观察到这个调节太快，平飞一段时间后，这个角度偏差较大，受风影响大。

20240603
新增一个RB命令，返回基点，但不删除基点。R命令返回基点后会删除基点。

20240604
取消老的电力控制模式，将电力控制设置为多个挡位可调，默认一个基础挡位，遥控可以设置，这样可以灵活更换电池而不需要刷代码。
飞控遥控两端新增预定义命令，20-26，分别设置电力控制模式0-6

20240606
新增了P0-P9共10个预定义点的命令。现在可以设置这些点，然后打点飞行。某些场合下更方便。
三个预设点简单测试没有问题，未携带高度设置，只是水平位置。

20240607
最大降落速度由10米放宽到12米，平衡推力自主调节范围放宽到5%，以适应高速降落场合。
微调命令解析函数，删除GPS坐标限制，允许全球坐标输入。
今日在笔记本上构建了Pico环境，使用1.5.1sdk, 构造出的uf2是1000kb, 比在台式机上的1068kb小不少。
这可能是台式机没有使用最新的sdk, 也许是用的1.5版本的，也可能是编译器不同。台式机上显示的是gcc 11.3.1版本
而笔记本上显示的是pico arm gcc版本，似乎是10.3.1的gcc版本。遥控器编译后也小一些，只有通信模块大小差不多。

20240608
简化测距模块不含光流数据的处理过程。

20240609
放开气压控高硬限制到10m/s, 之前限制在8m/s, 现在允许速度更快了。这里的硬限制影响电流控制的计算。
    FLOAT_LIMIT(pspd0, -10.0, 10.0);
    FLOAT_LIMIT(pspd1, -10.0, 10.0);
    FLOAT_LIMIT(pspd2, -10.0, 10.0);

平飞时调节_heading_yaw的力度再次降低。

20240618
修改高度调节控制，尽可能利用GPS高度，之前主要是用气压。

20240622
将气压和高度的换算由12.0改为11.2，这个比较接近实际。随着高度的增加，这个系数还更小。
绝对高度调节在起飞高度以上300米时只使用GPS定位。

20240623
增加5个函数用来处理气压和高度的关系，相对高度调节时，采用这个新的函数来推断目标气压值。
air_press_height_refer
height_dif_by_air_press
air_press_by_height
height_by_air_press
air_press_height_relation

//在气压控高里，引入气压变化因子，这样在高空中控制垂直速度更准确。这个暂时不改，影响不太大。
在气压控高里的GPS高度调节上，修改期望高度算法，使用height_dif_by_air_press

20240624
昨天做了几次爬高测试，900米，1500米，2000米，都安全返回。备份。

20240625
height_adjust_by_baro_with_landing_detect函数中遗忘了电流的记录。补上。
原始的高度方向速度功率控制很可能因为引入了vspeed而无效，vspeed很大时控制不下来速度。
现在修改为直接减速法，超过标准时，直接减力。稳定版本还没有改，测试版本还需要测试。明天回江西，返回后再测试。
macro_vertical_absolute_height_adjust 大幅修改。设置气压上下边界。气压边界内优先采用GPS高度。气压高边界用来做降低的保底，气压低边界用来做升高的保底。即便气压高度和GPS高度有矛盾，也应该不会太离谱。需要测试。

20240630
新的高度调节逻辑简单测试没有问题。修改后的高度方向的电流控制似乎也正常。备份。

20240701
将高度控制里的气压速度由原来的上下10m/s，单侧下降速度放松为11.5m/s，实践中的实际最大下降速度是12m/s, 之前的限制10m/s实际是偏低了。可能导致系统认为下降速度不达标，持续减力。由于有兜底的推力，所以也没有问题。放松硬性限制后计算应该更准确些。未来这里可能还需要适当放松。
平滑降落停机时间由2秒减少为1.5秒。在两个气压控高版本和测距控高里都修改。
微调高度方向的刹车，退出刹车限制的更严格，希望刹车后的震荡较小。
pin_to_location里，倾角放宽为35度，之前是30度。
gps_position_adjust里，倾角放宽为35度，之前是30度。两个放宽可以增加抗风能力。
balance里之前就是限制35度最大倾角。不动。
取消gps_position_adjust里，最大倾角随GPS质量而变的设计。

修改后的高度方向的刹车表现更好，刹车后反弹很小高度比较平稳。平滑降落缩短的0.5秒不太明显。

20240703
允许在空中修改电力控制模式，不必落地修改。
下午飞丢一架2306机器，当时在130米高度执行三个点位飞行，最后返航的命令，全程6.5公里，在飞往第一个点时似乎正常，然后飞往第二个点时，方向严重偏离航线，这可能是yaw漂移较大导致的，高度失控，降低为39米，信号消失，有可能是撞击了树木，但没有找到。
至于高度会降低的原因，可能是被电流限制了？侧倾近30度，电流7.9安。导致垂直方向上的调节电流没有了余量？但vspeed=0是不会限制电流的。
怀疑水平平飞的限流和高度保持冲突，因为方向错误需要大倾角去纠正，在水平方向上电流增强到一个上限，然后高度需要提高，又需要提高电流，电流提高了，影响了水平方向运动的能力，又导致水平方向上被风吹偏。有可能是这么个原因，即水平和高度方向的电流限制导致姿态纠正困难，要检查两个方向的电流控制是否存在问题。另外平飞时的方向纠偏还需要调节。目前纠偏很慢。
4/18日一次险情和这次飞丢极为相似。原因大概率是电流限制后的处理不当。
几次丢机没有找到原因，1个在河上忽然坠机，原因完全未知，2个爬高900米不返回，原因完全未知，3就是今天坠机，风力似乎并不大，原因也未知，只知道明显偏离航向，在方向判断上的误差很大。
将这个版本标记为可疑并备份。高度怀疑平飞时方向调节有问题，另外高度怀疑两个方向的电流控制存在可能的冲突，使得高度无法维持稳定。

备份后修改，pin_to_location里最大倾角回归到30度限制，之前改为35度。gps_position_adjust里，倾角限制改回30度。
这次飞丢和几个月前一个意外情况有点相似，当时应该飞行方向向北，但实际飞行确实S型曲线向东，那次即时发现了问题，用遥控器接管了，然后发送返航指令就飞回来了，飞回的路线很直，如果是方向判断有问题无法解释之前为什么走S型线路，而接管后返航又能走直线。

20240705
经过检查4/18日飞行记录，发现平飞时遇到大电流的限制后，飞行方向混乱。在找到原因之前可以考虑取消平飞时的电流限制处理，单纯限制倾角和最大速度也能限制电流。
目前限制电流的办法是发现电流过大则事后限制，并且是限制倾角大小，不同风向限制相同的倾角可能功率都不同。可以考虑以后改为事前限制，发现电流较大时限制倾角增加的速度。
查到在pin_to_location里，最后执行调节推力方向时存在长期错误，误将new_castx写为new_casty, 这使得x方向上的速度调节会附加在y方向。这应该是4/18日的奇怪飞行曲线的主要原因，以及最近一次飞丢的主要原因。4/18日在直线飞行时，可能突然遇到强侧风，有一个x方向的速度，结果调节附加在了y方向上，造成路线混乱。在x方向速度不大时，这个问题可能被掩盖，所以很多时候都没事。
这里做备份，未来计划在平飞和定点时再次尝试加速度方向匹配以识别方向。

20240706
已经将机身倾角变化匹配GPS速度变化应用到三大函数。定点测试刹车测试看起来没毛病。其是否有正向作用很难说清。反正调节量不能大，大了则方向波动很大。因为倾角的变化可能会是被动变化，如受到风力的影响。此时去匹配倾角的变化，可能完全反向。在乱风的影响下，是否对方向判断有正效果不好说，暂时不能作为主要调节方法。估计在多数情况下，会有点正向作用。

20240707
下午试飞，结果在几次前飞返航，五星飞行后，再次执行200m五星飞行时失控坠机，似乎是一个平飞任务不正常，执行姿态有问题，高度严重下降，电机发力在合理水平，尝试接管后飞控端确认了接管成功，中断任务，但遥控推高不管用，机器继续下坠。所幸找回。这次和上一次有类似，平飞时有问题，高度下降，路线不正常。可能是平飞的代码还是存在问题。另外遥控接管后应该进入刹车，似乎也有问题。这可能和机身旋转引起的角度偏差有关系，每次机身旋转都会带来方向偏差，累计起来可能方向偏差很大，大到一定程度后可能就会出错了。
今天发现，pin_to_location里的_heading_yaw调节里有一个错误。关于速度方向和指向目标点的夹角调节里，积分调节有错，虽然计算了四个最近夹角的均值，但没有用到它，做了修改，各参数做了修改，总体回到4/26的版本，但修正了积分调节错误，以及保留机身姿态和GPS速度变化的匹配。
gps_position_adjust里的积分调节_heading_yaw也有同样的错误，修正。

20240708
新增将输出信息写入遥控指令，现可以用指令输出记录信息。
在执行B(x,x)命令时，天空解析修改了base，这不对，修正相关代码，命令解析里很多混乱，多处修改。
下午测试了30分钟，多数是五星路线，基本没问题，命令解析部分的修改看起来没问题。pin_to_location在减速段上仍旧是存在_heading_yaw更新的问题，导致方向偏差很大。减速段和加速段的更新应该是反的。如何将这两种情况统一起来是个难点，如果要区分对待，又如何定义减速和加速段？如何避免出现异常时还能够正确调整方向？

pin_to_location里旋转调节修改为区分包裹目标点和不包裹目标点，这样应该可以更准确的调节方向。

修改加速度方向和机身倾角匹配调节，限制加速度方向必须大体指向锚点时才进行匹配调节，其他方向的加速度不匹配调节。

pin_to_location里基于旋转的调节时，引入距离信度，近距离下由于包裹情况可能有计算误差，调节速度慢。之前有距离信度计算但没有使用。

gps存储序列压缩到15个，节约内存，Imu之前压缩到了120个，之前是300个。气压数据压缩到了50个，之前150. 平衡借力调整为在3%内调节，之前是5%。

大幅加强加速度方向和机身倾角匹配调节，增加7倍调节量。加强曲线调节50%。怀疑方向调节力度太强了，导致最后接近阶段指向角变动很大。

20240710
在gps_position_stable里引入方向完全相反的检测，在执行了一系列平飞动作后，方向角可能会有很大偏移，如果方向完全颠倒，可能
会导致水平刹车出现问题，因为在完全颠倒的方向下之前的调节工具都失效。偏差超过90度时，调节不能使速度降低，需要进入大调节状态。

20240711
删除_heading_reliable相关处理。
测试了多次前向往返飞行，接管无误。悬停，刹车多次测试，没问题。备份。

20240712
在pin_to_location里也增加迷向检查，防范迷向问题。
中午进行了测试，发现遥控器的摇杆可能会失灵。意外飞行。
起飞时可能沿用上一次起飞的数据进行GPS定点调节，增加起飞时清理gps调节记录，其实这之前有标记，但这次改动代码后可能不参考那个标记。
遥控器需要增加软关机，此时输出全0摇杆数据，防止摇杆出现漂移问题，同时可以接收数据。
遥控器接管可能增加一个预定义命令，不使用摇杆去接管。
这样遥控可以先软关机，再派发任务，在任务出现异常确实需要接管时。
经过遥控代码调整，显示出来摇杆数据，确认十字摇杆的横向有故障或损坏，其控制roll方向。最近两次丢机最后都是倾角异常，可能和遥控器异常接管有关。
经检查，遥杆地线虚焊，导致采集电压等同于输入电压，结果是摇杆打到最大量，突破接管的阈值，并且持续输出最大量，导致飞机失控。
这两次丢机及几次炸鸡大概都是这个原因。现在接管不使用摇杆，今后任务中不会受到摇杆影响，并且摇杆可以锁定，应该可以最大程度避免此类事件。
发现大错误，在pin_to_location今天新增加的加速度逆向判断有错误，atan2没有乘以57.2958，结果角度计算错误，误判反向加速。导致角度变化过快，然后接管后姿态失常。

下次要做个实验来测试接管后刹车的稳定性，比如在速度较快时接管，此时故意调节方向角使得误差极大，看看刹车处理能不能及时发现方向不对短时间纠正。要在高一点的地方进行。

20240713
微调刹车，加强刹车力度，平滑波动，之前刹车波动明显杀一段缓一段，一段减速一段加速，容易造成方向误判。
引入加速度差分调节。争取刹车力度不来回震荡。
测试后效果不错，虽然还有部分回弹，但刹车线性明显更好。
已确认，7月3日飞丢的机器不是遥杆意外接管，确实是触法了之前的bug，导致横向S型飞行。至于高度为甚么会降低，还不清楚。7月7日炸鸡，是摇杆地线脱焊，触发接管，然后摇杆处于最大位置导致失控。
轻微修改气压控高，加强高差调节力度，避免大倾角飞行时掉高较大。大倾角下因风压造成下压力，会使高度短期下坠，如果调节力度太弱，则可能掉高很大，甚至持续掉高。而侧倾快速回正时，又会大幅升高。需要适当加强调节力度。
调节后测试了一下似乎没问题，直接应用在低空版和稳定版上。
在pin任务开始时，增加数据清理，防止连续的pin任务因数据连续造成的方向误判。
今日炸鸡一次，属于遥控不当，高度偏低撞树。然后损坏一片2叶桨，上下底板小突出撕裂。简单修复。上下底板小突出可能需要做圆弧过渡。不然发生撞击容易撕开。

20240714
当前版本下午测试了三块电池，反复飞五角星路线，方向判别稳定，姿态稳定，风力似乎是2-4米的南风。刹车表现不错，但风中定点没有测。平飞在稍大的风力下是否稳定还需要另外找天气去测试。目前感觉上比较稳定，备份。
由于近期改了遥控，接管不同了。一同备份。
修改gps_position_adjust里的期望水平速度。统一成和pin_to_location里面一样.
修改水平刹车下锚的标准，采用最近5个GPS速度的均值，和imu_acc的模量做限制标准。争取刹车回弹更小。

20240715
刹车下锚调节为速度，imu加速度，gps加速度三者联合限制。
微调期望水平速度，在5米距离内分段处理，这样定点飘摆应该更小，之前5米内线性处理太粗糙。
微调气压控高里高差调节力度和速度调节力度，期望在高速运动时高度更稳定。
增加气压控高里的kpx参数0.12->0.16, 增强ks参数0.15->0.16, 增强平飞掉高的适应性。

20240716
测试平飞时遇到方向角持续增大的问题。这可能是某种调节不对。
pin_to_location里，关于机身倾角变化匹配加速度方向的处理上，取消角度限制，怀疑有角度限制时可能导致单方向方向偏移。
同时减小调节系数。三个函数里，之前刹车没有方向限制，定点及平飞时有角度限制，现在统一都没有角度限制。而且统一修改调节参数大小，改为原来的一半。

20240718
找到一个新思路，将加速度沿着指向目标方向的直线分解为平行分量和垂直分量，垂直分量可用来矫正方向，似乎可以避免侧风影响下的加速度调节产生的偏差，即这种方法似乎是无偏调节。

20240719
目前基本满意，方向判断很好。备份。
中午多次测试200米的五星飞行，稳定，方向判断准确。下午大风中定点稳定，方向判断准确。

20240720
增大加速度和速度角度差调节系数到原来的3倍，因测试中其判断准确但调节力度偏小。
减小加速度和机身姿态匹配的方向调节系数，降到之前的70%，这个调节幅度大波动大，准度较低。
大幅减小方向角的调节力度。

pin任务新增记录起点位置，修改终点掉头方法，之前是当前yaw转动180度，现在是转向指向起点位置。
本来记录起点位置是想要处理基线问题。但如果遇到方向错乱的情况，可能会很难处理。比如反向的情况。要处理基线可能会导致混乱。暂时不考虑基线问题。

加速度和速度的夹角调节，是近距离调节项，随距离大幅衰减。之前的调节似乎是搞错了方向，现在反过来处理。


20240721
修改了地面端的发射频率，扩频等参数，希望能增加遥控距离，这可能和天线的谐振频率有关，需要多次尝试。
下午测试多次长线往返，方向识别基本完美，比之前要好，不过今天风力偏小。
修改过无线参数后，垂直方向的遥控距离依旧不理想，300-400米左右，似乎水平远距离尚可，没有测试过。
取消pin_to_location里基于飞行方向和目标方向的夹角调节方向角，把这个夹角调节放在旋转推力上，使得这个调节类似于方向舵的调节。定点里面直接取消这个调节方向角的代码，但不增加方向舵的调节。

20240723
balance里修改最大输入倾角限制，修改远离阻尼角度限制。
微调pin_to_location里的舵向调节，稍增大。
G命令的解析上，在计算距离时弄错了经纬度，修正。

20240724
微调方向角的旋转调节。微调基于垂直于路径方向的加速度的方向角调节。
自19日备份后代码修改的很少，基本都是微调然后测试。最近的一次炸鸡属于遥控器摇杆问题，导致意外接管。
最近的平飞飞丢是因为平飞代码之前的一个长期存在的bug，触发概率较低，已修正。上一次爬高900米飞丢可能是爬高代码不够完善，昨日多次测试爬高已经没有问题。最近三次问题均已找到原因修正。

20240727
微改关于飞行方向变化识别方向的调节，区分加减速，用夹角大小调节信度。

20240730
刹车时方向角有超调，下一部要纠正这个问题。目前平飞稳定可靠。方向角调节也基本可靠。备份。
此次备份和19日的备份没有大改动。近期集中于测试和微调。几十次平飞和爬高没有飞行事故。

20240731
似乎是倾角姿态和速度变化的匹配存在时差，推力变化角和速度变化角有持久的差异，导致长期偏量调节。修改姿态变化为2+3+4+5-6-7-8-9，而速度变化测量为0-5

20240802
飞控发往通信板的校验码改为crc8，之前是简单异或。这个校验码通信板如果检查有误会向遥控器报警。

20240804
最终通过测试确认关于机身倾角变化匹配GPS测量的方向角调节方向。看起来方向不发散了。备份。

20240809
注意到如果姿态调节量太小则在定点时不能及时寻找到正确方向，所以加强了姿态调节量。当依赖于Imu加速度的阻尼太强时，位置看起来很稳，漂移很少，但由于太稳，没有机会匹配方向。所以要适当加强调节量。
轻微修改电力控制方案，现在默认方案限制电流更强。

20240813
为抑制yaw角漂移，在接收数据后增加处理代码。

20240816
昨日修改预定义命令里的0号命令，即返回起飞点，改为其他命令码了，以后不使用0号命令，0号作为无命令处理，这样可以简化接收端的处理，不必增加一个处理标记。不过还没有去掉标记。

近期代码改动都不大，又测试了几天，备份。

20240818
取消前几天增加的抑制yaw角漂移的代码，那个代码试图推断漂移位置，但实际表现不佳。回到老代码，即只依赖初始校准的漂移量。

20240824
飞丢一台2306测试机，此机在上次飞丢后建造，曾经高速度炸过一次后找回，电机轻微松动，其他正常。
本次飞行为三角形路线，风力较大，估计有3-4级，电池松下4s1p，全长13.5公里，是在之前的三角形路线上稍放大2公里。预期飞行时间20分钟左右。飞往首点时到550米一切正常，后信号消失。此后再无信号。具体原因无法查证，坠落地点无法核实。这次命令和之前的三角飞行命令稍有不同，之前是B,A,G,G,R,LH,这次修改为A,G,G,LH, 取消了前后的B/R, 按理是一样的。

升级sdk到2.0版本，变化很大。新版本支持新的芯片RP2350
本次飞丢初步判断是硬件方面的问题，比如固定GPS的皮筋老化导致GPS脱落，电池绑带断裂？
20241006补记：很可能是电机问题。2306炸鸡后可能电机转子和定子会有错位，导致电机kv值变大扭力不足，大推力下可能出问题。

20240901
新造的机器使用长方形控制板，没有指南针，通信板由于是长方形，使用的是小型的pico，模拟的uart接口。新机器尝试兼容4s2p长条电池。gps插口和通信插口做了交换，需要软件配合。另外是非对称设计，首次起飞摇晃较大，需要调参。测距模块换了新厂家的，代码也同时更换了新的。长条形布置，roll方向的调节力需要减弱。电流表系数做了调节。

20240903
增加代码，可在自动任务时接受遥控指令修改电源方案。
取消了预定义命令的标记，使用0表示空的预定义命令，接收到预定义命令后把预定义命令置0即可。
修正了侧翻时的处理，之前翻转后机器会持续输出最高发力，原因不明。现在会停机。

20240908
怀疑balance里对于角加速度的调节参数太强，可能引发意外的机身强烈震动。降低计算跨度，原为10个数据差，降低为5个数据跨度差。并且调小系数。经过调节后依然抖的厉害。恢复10个数据差，恢复原系数。
总体调节力度ratio由60调节为35试试。35不震荡，尝试45，然后tof控高那里明显的系数偏强了，上升快降落快，易失控。
tof控高里ratio 0.1->0.07
balance里ratio=45还有微震，调低到40. 气压控高ratio 0.15->0.12, kx 0.36->0.38, tof控高 kx 0.35->0.4
由气压控高下降到测距控高，在新的2806机器上反弹明显，需要调低增力。
balance里ratio=40依旧偶有抖动，降低到35。
由气压控高下降到测距控高，调低后依旧反弹严重，可能和测距精度有关。也可能是速度的调节系数过大。
调小tof控高的速度系数kd, 0.3->0.2, 气压控高里的ks, 0.16->0.12, 再继续调低气压控高的ratio, 0.12->0.1 之前是0.15
气压控高刹车时，高度有大幅抖动。tof测距时，高度超过设定后推力下降太过，导致迅速坠地，或许可以通过提高最低推力来预防。要么设定一个最大向下速度。
tof控高增加无速度设定时的速度限制。
减弱气压控高里的气压加速度调节项kpx 0.16->0.12
微改tof控高期望速度，之前是直接匹配设定速度，现在是当设定速度为0时，设置一个匹配设定高度的速度。

20240909
新的气压控高里的随GPS高度调节应该稳定，把稳定版也修改成一样。
目前测距控高在新机器下不稳定，高度控制很差，其测距数据的延时可能和早期的模块有区别，另外，新电机2806的平衡推力值较低，调节推力时，可能存在一个线性度的问题。

20240911
近几天调试2806电机发现比较难，可能的原因是2806比2306自重大了许多，其导致的惯性较大，而机身强度不强，因机身变形导致的传感器延迟会比较大。

20240912
今日测试遇到了气压的剧烈变化。同样的气压在不同的位置上高度相差10多米，160的高度，后来降低为150，这还是有GPS高度调节的情况。所以再次修改了GPS高度调节算法，使得GPS高度调节可以在更大的气压波动范围工作。
20241016补记：早前的气压模型偏差较大，算出来的气压上下限和GPS相差较大。

20240913
修改了定点参数，增强了调节力，减小了Imu加速度的阻尼力，这样在定点时，可以更好的识别方向，之前的弱调节力导致运动强度不够，识别不够准。
在气压控高二次调节里，增加imu有偏的处理，之前只考虑下偏防止飞高，现在增加防止上偏使高度始终低于设定值。

20240914
新机器2806和老机器2306的不同处
电流表电压表系数不同
指南针有无
通信板，GPS接口交换
平衡函数里系数不同
tof测距模块硬件不同，代码不同
以上软件要对应调整。
硬件方面电调不同，控制板的布置不同。
滚转方向调节系数不同

20240915
2306带摄像头在降落时，速度偏快，加强速度匹配系数。微增气压加速度阻尼。

20240916
远东21700 6000mah电池，悬停测试最大64分钟，放到10.0v, 61分钟，放到11v， 2306电机 9寸
累计电量270kj（到10.0v），常规5000mah电池225kj左右, 确实是大了20%

20240917
上午测试在平飞时坠机一次，证明是桨叶和机臂碰撞造成的失衡，可能是几次坠机的原因。2叶桨较软，距离机臂很近，有碰撞可能。
在get_spd_acc_lmt_by_dist里压低加速度限制，实测平飞的起步加速度较大，可能导致桨叶打到机臂。需要温柔一点。
20241006补记，实为电机问题。

20240918
当前版本可能是坏的，自昨天坠机后整个机器不稳定，常常升上去就炸，硬件损坏？但换了电调，炸鸡的2306电机也反复测试过看不出问题。所以怀疑软件问题。
如果是软件问题，那可能是坠机后修改的部分有问题。
经过检查，当前的软件问题不大，炸鸡是电机有问题。2306带9寸桨在剧烈加速时电流很大，可能导致过热烧毁。
更换2806电机后，机身重了很多，带9寸桨今日飞行测试稳定。但长期是否稳定需要时间检验。

20240927
修复2806炸鸡，主要是更换机臂两个，所有桨叶，通信电路板线路修补，更换通信芯片一颗。
尝试把水平刹车处理中的参考倾角错位处理，因GPS有测量时间差，怀疑这个导致刹车摆动。具体表现看测试。

20240928
在pin函数中，增强加速度差分调节，希望加速度更平滑，起步时或许更稳定，怀疑在2306电机上，起步侧倾过快可能导致负载过大存在烧电机的隐患。同时在gps_position_adjust里也调节这个参数保持两者一致，以便将来合并。

在pin函数中，修改阻尼方案，之前加速度和速度都有统一的随距离变化的阻尼，修改后分开，远处无速度阻尼，有加速度阻尼，近处则阻尼都加大。这是为了在加速时更平缓。定点里的调节也同时修改。保持两者一致。

20241003
放松气压计算高度时的容错到5%，因为观察到飞到海拔200米实际只到190米就触碰到了气压低限制位。为了尽可能以GPS高度为准，所以放松气压限制范围。新增X0-X9定义预定点的指令。

电机偏小带来的长期损伤导致炸鸡概率可能非常大，一次是往返观景台，在返回途中距离1公里左右炸了，当时以为是电池松动造成，现在看是电机问题。似乎是2308电机。一次也是往返观景台，带摄像头，莫名姿态失控，应该也是电机存在问题。一次往返1公里，飞出去300多米掉水里，很可能是电机损伤。一次是爬高900米失踪，2306电机，可能是电机问题。最后一次飞丢是三角形路线，飞出去500米失联，2306电机，大概率是电机问题。再然后就是试验场的头顶加速后坠机，此次坠机后经过检查才发现电机有问题。这才回忆起以前几次炸鸡可能都和电机损伤有关。

调整电流最高档位限制下的水平速度和垂直速度阈值，降低要求，即在最高电流挡位下，对速度的要求降低，限制在极端恶劣条件下飞行时，电流持续过高放电。

20241005
根据今天新测试数据，更新气压模型，air_press_by_height/height_by_air_press两个转换函数更新。
air_press_height_relation也更新。
气压控高函数里的11.2全部换成11.719，这是每米高度上的气压变化数据。

20241007
测试爬高4500米正常。平飞4.5公里往返正常。备份。
新增动态气压高度关系计算，在气压高度控制函数里计算，每3秒计算一次，之前按固定值11.719/m来计算，但在高空时，这个系数不正确，偏差很大，导致设定的速度不能执行到位，在爬高时最后快到达目标时，速度往往过大，这是因为在高空中这个系数是要大大减小的。比如在4500米时，这个系数是9.487，因为气压速度之前采用固定的11.719来计算垂直速度，所以在高空实际控制的速度偏大了，大高度爬高时容易过冲，而降落时，也高于设定速度降落。设定降落速度12米，实际降落速度15米。修改暂时只放在低空控制函数里。

20241008
增加能量警卫PG和电压警卫VG命令。把稳定版气压控高也修改为和低空版相同，其中包含有可变的气压高差关系。这几个功能都需要去测试。前者可以用悬停命令配合。悬停命令时间放开到5000秒，之前限制600秒，放开后几乎是无限制了，这样配合警卫可自动测试悬停。

20241009
PG/VG在悬停上已经做了测试，可以正常监控能耗/电压并降落。在平飞阶段打破自动飞行并返回还没有测试。
为预定义命令做了列表，轻微改动。

20241010
将东南西北命令取出，用的不多，而且可以用M指令代替，这样可以节约出四个字母ESWN用在其他功能上。

20241014
从测试来看，风力较小时，2806 kv1050的电机带9寸2叶下，平飞每米能耗在10.5j左右，4s1p 5000极限21km, 之前的2306电机9寸可以见到8.5j左右。2806比2306电机重了太多，平飞效率较差。但2806比较稳定，没有意外停机。
在爬高方面，2806/2306差异不大，基本都在22-28kj/km左右。估算爬高到6000米消耗162kj能量。都是空机比较。爬高能量消耗是平飞的2倍多，大约在2.5倍。据此计算爬高10000米需要平飞25公里的能力。这里计算的只是单程，要返航还需要跟多的能量。在目前的2806电机下，可能只能飞到7000-8000米高度。

20241017
目前的电流控制是分挡位的，可能在控制时存在突变，姿态角的抖动可能会较大。考虑以一种代价函数来平滑这种控制。电流大到一定程度后再升高的代价就更大。其代价用来抵消速度的拉动。
平稳的电流控制有利于摄影，当前摄影抖动较大。

20241019
10个预定义点之前是全局变量，现在只在解析命令中处理，只对一组任务有效，避免不同任务混淆预定义点。
下午测试炸鸡一次，因电量耗尽，气温低的时候电量远不如预期，力神4000电池往返1.176公里5次后电量几乎耗尽，但此时似乎通信供电已经不足，无法接管，任务设定为7次往返，电量超过180kj返航，最终耗尽电量达到150kj炸鸡，此电池正常电量180kj。气温13度，只放出150kj.

20241022
下午试飞全碳板机架炸鸡，原因是震动导致螺丝松动，电机松脱。

20241025
下午炸鸡一次，当时处于平飞后的降落状态，距离地面15米左右高度，然后失去平衡，2806电机 kv1050，这个电机19日因电量耗尽炸过一次，感觉没事，可能存在内伤。炸鸡前已经飞行了近40分钟，两组电池。除电机问题外，可能的原因还有电调过热，还有主控板的问题，主控板后来连接通信板时存在问题，通信板可以收到遥控信号，但主控板没有收到，检查后发现连线没有问题，换主控芯片也没有解决，多次插拔连线后又正常了。表测通信板的发送脚连接主控板的接收脚是通的，但无法收到遥控信号。问题有些奇怪，也许暗示主控板存在问题。炸鸡也许是主控板有点问题导致的。这架机器上次电量耗尽坠机之前也尝试了接管，结果也是通信短链无法接管。说明这套控制系统和通信系统存在一定的隐患。合适的时候要换掉。

今天对比了三星50s和易成阳光的电池差距很大，都采用4号电源方案。50s飞行了5个往返（1.18公里），然后再飞了1000米后触发13v低电压返航，没有触发180kj总能量返航，到返航时总飞行12.8公里。易成阳光飞行了4个往返，然后再飞行了1700米来到13v低电压返航。返航前总飞行11.14公里。然后降落时炸鸡。两电池回压14.13，14.43，显示后者电量更多。事后充电，三星冲了3.55ah, 易成阳光冲了3.03ah, 易成放电压降比三星大。易成不适合高挡位放电。原因如果不是电机问题，那可能是电调过热保护，也可能是电机连接电调的焊锡有问题掉了。因落地时机臂断了一根然后对应的电机三相焊锡掉了一根线。大概率是机臂断了拉扯了线导致的。

20241026
修改了电能积分，电能积分使用瞬时值。平滑后的值用于显示和控制。
增加了imu温度飘移补偿代码，目前补偿值较小，不影响系统方向。

20241028
对于罕见的炸鸡，不一定是电机问题，现在怀疑和电源有关，BEC转换可能存在输入端的电压波动向输出端传递的问题，输出端电压如果不稳定，可能会影响发送给电调的信号稳定性，导致电机失去稳定性。在输出端增加一个电解电容来滤波，再尝试长时间测试，看看会不会出现异常。另一个可能性是电调过热，现在尝试电调后移来避免过热。这两个问题都解决后，再进行强度测试，才能看出来是否解决了稳定问题。

20241030
今日在飞控上增加了电容，用来给5v供电稳压，这是首次引入电容的飞控板。飞了5组电池，没有出现问题，但这还不足以说明之前是因为缺少电容导致问题。在没有电容时，出现异常失控的概率也不算常见。所以要对比这个电容的作用，飞20组-30组电池可能是合适的测试长度。如果20组电池飞下来没有问题，大概率之前多次失控就是电容引起的供电问题。而不是电机稳定性问题。

20241031
电容换成了新买的小固态电容，6.5v 330uf, 之前是35v 1000uf, 飞了3块电池没问题，天气不好就没继续飞了。带电容的控制板目前已经飞了8块电池没毛病。

20241101
今日测试了4组电池，前两组没问题，后两组风力加大，然后通信板崩溃死机了，主板仍旧正常控制飞行直到自主降落。
显然是电压波动过大造成。
通信板上无电容，主板上有电容，一个方案是通信板上也增加电容，或者主控板上增大电容。
新购了680uf电容还没到，先在测试机上再并联一个330uf电容，这样是660uf电容，未必能使通信板供电稳定，但目前的方通信板没有电容位置可安装，只有长条板能装，将来条板通信板可考虑安装一个电容。

20241103
今日测试了2组电池，没有问题，后来GPS定位漂移很大就没继续测试了。基于全碳机架2806电机。测试后更换为2306电机以减轻机器重量增加续航。

20241104
下去去测试，之前为了提高遥控距离，对天线做了延长，延长线正好遮挡了测距模块，结果高度失控炸鸡。碳板机身无损，测距模块损坏，通信模块似乎损坏一个芯片，主控模块imu不正常。电机没有细测，估计有轻微损伤。2306电机，全碳机架，8寸3叶浆。
后用老的测试机飞了两块电池，这个机器上的主控装了2个电容，感觉影响通信板，遥控控制距离很短，甚至长时间不可控。
目前带电容的飞控飞了16组电池没有意外坠机。
经过拆解检查，是主控芯片有问题，Imu应该没有坏。可能是主控芯片的spi损坏。重做了一块板子，换上了新的更大的680uf电容，一个顶俩。老板子的插座也是有损坏。

20241105
今天飞了3块电池，2306电机，8寸3叶桨，用的是昨天新做的主控板子，电容是新到的680uf，结果电压和电流采样均偏低，似乎和这个大电容关系很大。电压电流都需要重新校准。
目前带电容的飞控飞了19组电池没有意外坠机。

20241106
8寸3叶桨和9寸2叶桨在悬停上的效率相差大约20%, 8寸3叶桨悬停2分钟耗能8.6kj, 9寸耗能6.9kj

测试悬停59分40秒到10.0v, 易成阳光5000mah电池，积分能量200kj，机身386克，电池302克，电压已经校准，显示电流表偏小了。这个电池12v以下还有9%的电量。12.5v还有16%电量。13v还有23%电量。13.5v还有32%电量。

推算6000mah电池可悬停 70分钟以上。实测悬停67.5分钟，电池衰减，实际放电5.8ah.

20241107
今天下午测试了5组电池，2306 9寸2叶 碳架，全部飞行正常。能量消耗大体上为7.9kj/km，但目前的电流表系数和早期标准不同，不能比较，只做参考。
目前带电容的机器已经测试了24组电池无意外坠机。

20241108
再次跑了整块电池的悬停，采用易成5000电池，悬停59分半，和上次数据相同，20分钟放电77.1kj, 30分钟115.6kj, 40分钟154.4kj, 50分钟192.4kj, 最后229.6kj, 电流表矫正基本合适。全程yaw角漂移-127度， 约每分钟-2.1度，每秒-0.035度，每数据-0.00007度

20241109
下午测试了5组电池，目前带电容的机器已经测试了29组电池无意外坠机。已经接近了10个小时飞行时间。而且今天有风，比较考验电力的稳定性。应该比较肯定以前的意外炸鸡就是供电问题了。

20241110
取消imu温度补偿代码，似乎有反作用。修改电力控制方案代码，采用代价函数来处理，似乎更平滑。

20241111
测试没问题，备份。
平飞中增加飞行效率控制，尽量选择最佳效率的速度去飞行。

20241112
下午测试了2组电池(累计31组无炸鸡)，机器带摄像头。后一组在起飞阶段电流飙升到很大的值，这主要是在低速阶段加速时对电流放松的太多了。纠正这个问题。
另外进入目标点时摇摆较大，时间较长，这可能和电流控制不连贯有关系。对于飞行效率的速度调节，限制在80米外。

20241113
再次修改电源控制和动态飞行效率优化。之前的测试表明加速时电流可能会很大，会有失控电流出现。

20241114
下午飞了4组电池，一组不带摄像头平飞往返1.2公里7次，一组不带摄像头拔高2000米测试，一组带摄像头拔高3000米测试，一组带摄像头平飞往返1.2公里7次。至此累计35组电池无炸鸡。

20241116
之前温度补偿搞反了方向，现在纠正，然后再次应用。

20241120
近期在2806上炸了几次，是因为测距模块的固件有问题，经过代码防范解决了这个问题。
增加了对测距模块的防御代码，防止测距返回错误信息。tofsense有这个问题。
备份。

20241122
测试飞行两组电池没有异常，目前已经累计测试了37组电池无异常。
发现摄像头开机会严重影响GPS信号，但即使是10个卫星信号依旧可以正常飞行。

20241123
今日飞丢一架，风力很大，似乎因迷失方向而导致纠偏时电流持续超大，速度持续超大，电量迅速耗尽。
headingyaw在以非常大的速度变小，最终-146.0，初始值在-45，3分钟左右变化-100，显然是非常不合理的速度。高空温差可能导致这个剧变？又因为机身后来始终压着侧倾的边界飞，最大32度，导致电流剧烈增加，水平速度很大，消耗巨大的电能，这导致高度不能稳定，飞机持续降低高度，电量也迅速耗尽。大倾角高速度下阻力极大耗电极大，这个必须限制。在速度过大时限制倾角，在电流过大时限制倾角，或可避免系统方向错乱时陷入大量消耗电力的麻烦。

这可能和近日修改的电流方案有关，似乎存在问题，GPS看起来正常。最终掉水里了。
速度失控，这可能是代码限制的不够好，没有硬限制，系统认为飞越快效率越高，于是一直加码速度，然后导致机身震动失控，然后影响了方向判断，然后方向不能被及时纠正，死循环。
应对措施是增加硬限制，电流上限和速度上限的硬限制，机身倾角硬限制由32度调节为30度。

查看更新记录，上次修改能量控制算法（20241111）后，仅飞了8组电池，到今天就丢机，这个新的能量控制算法可能是有问题。原因不清楚，但新增了硬性电流控制，直接限制倾角上限，确保电流不超标。这样即使是方向上有大偏差，应该也有机会修正。这次的问题一个明显特征是电流失控，倾角压到了最大，速度极高，能量消耗巨大。把这个问题控制住则可能解决问题。另外为了防止过冲，调高了加速度和速度的调节限制，也可以防止中途风力干扰。另外去掉了imu温度调节，减小了加速度的方向匹配。
20250117补记：飞丢原因很可能是水平飞行代码过于追求电源效率，忽视了高度控制，在进入死锁角度后，高度无法维持，但水平飞行算法因为效率不肯减小倾角，最后是高度一直降低后坠毁。存在这个死锁角度是近期一次短距离飞行发现的，之前没想到会有这个角度并且会在限制角度内发生。

20241125
昨日修改代码后测试了4组电池，飞行正常。降低了headingyaw的调节力度，似乎带来了更好的稳定性，长时间飞行下来，方向角稳定性高，变化不大。考虑到加上滤波电容后已经测试了41组电池，所以应该是可以确认这个电容是有必要的，也解决了偶然的炸鸡问题。
昨日测试风力不大，不能确认是否纠正了之前的错误代码。但可以确认的是20241111修改的控制功耗的代码存在问题，这期间的代码不能用。
备份。

20241126
微调headingyaw的环绕调节，去除距离信度和速度信度，用两个调节系数取代。

20241127
增加电流放松因子，在速度很低时，允许电流超过设定值一定范围以便对抗强风。略微降低环绕形态下的hy调节力度。

20241129
昨日新做了一块天空通信板，是为火蝠sx1278设计的。火蝠sx1278比较起来更轻。适合天空端。
今日新做了一块地面通信板，发射端替换为火蝠sx1278w1，这样发射功率上去了，希望能提高遥控距离。

20241130
今日测试4组电池，平飞2组，飞高2组。飞高时在高空发生测距意外，终止了降落。为了避免此类事故，tof控高里取消了只有1个或2个测距有效的控制，测距控高必须有连续3个有效数据，并且数据接收时的信号强度提高到20才算有效测距。
带电容的飞控目前飞了45组电池无异常炸鸡。

20241201
暂时关闭加速度和速度夹角的hy调节，怀疑没作用或是不可靠。必要时可以再打开。

20241202
在气压控高里修改代码，将功耗限制改动，去掉老的代码，新增的功耗代码是自适应垂直上升的速度，能够以最优的能耗比上升，处理更平滑，之前这里是分段的，也没有自动识别最优速度的功能。暂时只在低空控高里添加，测试稳定后转稳定版。

20241210
近几天新做遥控器，更换摇杆，调整代码等，包括飞控端的代码也做了修改，摇杆的顺序重新定义，不兼容以前的飞控版本。

20241211
修改参数记录函数，现在是4字节名称+4字节数据，和老的方法不兼容，将来计划把电流和电压的调节数据写入进去，以及各种飞行参数写进去，就可以不用在修改参数时重新编译整个代码。但需要一个独立修改参数的程序，要么就做在遥控器端，通过遥控器去修改各种参数。
新修改的代码在飞控连接usb端口时进入参数配置状态，可以在此修改各种参数并保存。

20241218
近期修正了老的测距硬件mtf-01的代码问题，之前由于对tofsense的测距模块修改代码引入了新的记录数据，导致老的测距模块不能正常测距。
近期修正了气压控高里的一个问题，这个问题是新的自适应爬升速度所引起的，上打摇杆不能升高的问题，是因为没有触发能量限制，然后没设置速度差调节项导致的。

目前工作稳定，备份。

20250110
昨日飞了新组的机器，挂树上了，临时用的7寸3叶桨。
发现一个问题。在某些硬件组合下，死锁角度有变化，这里的死锁角度是指在某个侧倾角度下，无论怎么提高动力都不能抬高机身高度，因为迎面的风导致下压增大，速度越大下压力越大，这类似于斜面摩擦力的死锁。
水平飞行时，由于只考虑平飞效率，可能会把侧倾角度搞的很大，此时进入死锁角度，高度逐渐无法控制的下落，越飞越低。必须减小角度才能恢复高度。要么就是强制限制角度在死锁角度以内。但死锁角度随硬件变化。这个机器用8寸2叶桨平飞没问题，但临时用7寸3叶桨出问题了。
另外，这次和逆风飞行似乎有关，当时逆风飞行眼看这掉高度。这估计是因为水平飞行为了提高平飞效率加大了侧倾，但这个侧倾进入了死锁角度范围。
平飞算法可能需要考虑高度稳定，如果高度无法维持，则观察水平速度，水平速度如果够大则降低侧倾以给出电力余量供给高度调节。因死锁角度不固定，所以是一个动态观察过程，高度上的控制需要水平控制来给出余量。

20250113
昨日找回飞机，基本无碍。这次的状况和上次丢机11/23相似，说明上次理解错了，不是方向迷失。再上一次飞行三角形路线时，也可能是风大导致角度死锁。
微调hy调节代码，在上次飞丢后以为是这里方向判断有问题，实际应该是控高死锁角问题，所以微调更靠近老版本。
平衡函数里将倾角限制在30度以内。之前是35度。主要是考虑到角度死锁问题。倾角太大时，多大的推力都可能无法维持高度。
在pin_to_location里新增随速度变化的硬性角度限制，之前的硬性限制是死的。

20250116
减小运动曲线环绕时的hy调节力度。避免侧风下路径弯曲调节过大。

20250121
今日一个爬高测试显示出奇怪的问题。任务是爬高1000米，再回落到100米，反复多次，但在回落到100米的过程中，到达300米时就发生了高度的震荡，震荡范围在290-320米之间，下不来，检查数据发现气压没有计算错误，暂时不知道问题在哪。

20250122
再次测试后分析记录，发现了回落产生震荡的原因，这是因为micro_task.vspeed是一个int8_t类型，设定的降落速度超过了12.7米就会得到一个溢出值，从而反向运动。这个值作为int8_t类型很久了，但一直没发现出问题。
将这个值类型改为int16_t.

20250201
找到了识别usb插上的方法，可以进行参数配置了。执行H(50)失控的问题没有找到，系统完全没有日志记录，怀疑是硬件问题。本地测试H(20),H(50),H(100)没有问题。

20250214
近期有两件事值得关注，一个是春节在外地执行H(50)失控的问题，没有日志记录没找到原因，初步怀疑雪地环境下激光测距可能有影响误报。一个是昨天在执行南北往返飞行时持续缓慢掉高，但后来无法复现，怀疑也是tof硬件问题，如果在气压控高时，tof测距抽风间隔的返回有效测距，则可能打断气压控高，导致气压控高不断的重复设定气压高度。
这两个问题的一个解决办法是在适当的时候关闭测距，只使用气压数据。比如在爬高时，平飞时，不使用测距数据控高。而下降时开启测距控高。这样或可避免测距模块带来的不稳定。减小相关风险。

20250219
增加usb连接时导出日志命令dump, 微调气压高度控制，应该不影响稳定。

20250223
新增代码防止测距模块死机导致控高崩溃。

20250224
下午测试中，测距模块误报频繁。现已基本确认，上次在雪地的H(50)是测距模块持续误报导致的高度失控。因为持续的错误测距数据，控高一直停留在测距控高模式下，宏任务的速度调节被错误的测距干扰而无法控制垂直速度。

20250227
微调控高代码，包括测距和气压。放松水平最大速度到20m/s，微调平飞代码，主要是随速度增加的倾角限制。

20250302
下午进行了几次测试，都是新路线，飞行稳定效果不错，但在平稳飞行中的方向偏差仍旧是个问题，不影响飞行但影响拍摄。因此微调加速度和机身匹配方向判断中的系数，希望平飞途中能够捕捉到细微的方向信息来更新方向。

20250303
适度修改舵向调节的力度，以避免方向判断偏移较大的情况。这可能导致飞行路线稍有弯曲。

20250307
自去年11月下旬飞丢一架机器后，找到其飞丢的原因大概率是因为倾角过大风压导致无法维持高度，针对这个问题改进后测试了几个月，期间有次因为测距模块失常而坠机，基本上没有太大问题了。其他一些小的调整不影响稳定性。软件层面应该是稳定和可靠的。标记为稳定版本，备份。

20250313
这期间做了几个修改，但突然就出现问题炸鸡了，恢复了备份版本。这期间发现系统的critical_section_t已经用到了极限，再增加就出错。
然后对比炸鸡版本和备份的稳定版本，其主要修改的地方：

有问题的版本
critical_section_t imu_queue_section;
critical_section_t press_queue_section;
critical_section_t tof_oflow_queue_section;
critical_section_t gps_queue_section;

备份的稳定版本
__not_in_flash("data") critical_section_t press_queue_section;
__not_in_flash("data") critical_section_t imu_queue_section;
critical_section_t gps_queue_section;
critical_section_t tof_oflow_queue_section;

其他地方也有小改，但怀疑是这个改动造成的问题，修改后去测试就炸了。这些critical_section_t可能都需要放在运行内存里才足够安全。

恢复3/7的备份后，移植了这之后的几个修改，然后简单测试了几次没有问题。

20250314
将gps,tof的critical_section_t更改为 mutex_t类型。
将控高函数里，确认落地后标记_inair=false。
将宏任务里的降落任务增加一个_inair判断, 如果!_inair才确认命令已经执行到位，避免误判导致空中关机。之前只依赖一个微任务执行完成的状态，可能会有误判。

下午去外面试飞，结果第二块电池炸鸡了，这次是突然的炸鸡，没有姿态失稳征兆，有较多的无线干扰，很可能是被电磁脉冲击落，没有飞行记录，只能读到第一次飞行记录，路线非常正常。
上次炸鸡3/13，损失2个机臂，2个电机，一块主碳板，两个桨叶，一组电池，几根铝柱，电源插头等。这次炸鸡损失两个桨叶，一个机臂，一个通信主芯片。
有机会需要再次确认上次炸鸡是否是软件问题，留下了飞行记录，但其过程不合理，怀疑也许和电磁干扰有关。

20250315
微改代码，注意控高函数的返回值以及landed的返回值的处理，避免误判降落。
为电流采集队列增加mutex, 在平飞时改为读取三个电流均值来判断效率，并使用mutex避免数据不一致。

20250316
上午测试了一块电池，飞行没问题。3/14测试炸鸡很可能是被击落的，主控芯片被强电磁打击陷入崩溃。
水平移动距离修改为在GPS信号接收时对速度积分。其他的水平移动距离计算取消。
备份，虽然水平距离积分的修改没有测试，但目前相信这个修改问题不大，这个版本应该是比较稳定的。
20250319补记，这个版本里用到了mutex，会有重入问题，必定会崩溃。已经删除这个备份。

20250318
下午测试，高度是地面拔高100米，南北1km往返，首块电池飞行稳定，持续飞行16.9km后亏电返回。电压12.5v,积分能量191.6kj,后于5米高继续悬停直到10.0v,能量积分228.6kj,后充电4.91ah

第二块电池重复上一个任务，几个往返后坠机失联，和上次情况类似，失联前没有任何姿态异常情况出现，似乎是直接坠机。通信板报告了skyend uart break信号两次，再然后就完全没有信号回传，虽然找到时是通电状态，天线也没有损坏。
这个版本是从3/7备份的稳定版本修改而来的，首先是3/13的炸鸡留下了记录，看起来是逻辑混乱，然后恢复了3/7的备份，然后增加了一个电流采集的Mutex,然后修改了gps和tof和log的critical_section为Mutex,然后平飞效率改为多个电流平均，增加了imu温度补偿，增加了gps累计里程积分，增加了roll偏大时的干涉调节，增加了最低速度保证项，其它没改动。
怀疑后两次炸鸡不是受电磁打击而是修改引入mutex导致的死锁问题？之前用critical_section没有问题。

将gps,tof改回critical_section_t, log/current还是用Mutex
发现确实是mutex死锁问题，如果宏任务规划进入了锁住了gps mutex，此时中断发生，那么主线程其他任务全停，先执行中断，这时中断再去锁定mutex就死掉了, 这里用的不是recursive mutex, 不许重入，所以中断第二次锁就死了。包括tof也是，中断里不能用mutex.

取消current_queue_mutex，担心可能存在死锁问题。

20250319
删除20250316的备份，因确认mutex使用不当，备份当前版本。
轻微放松水平移动时的加速度随距离目标的限制，期望在高速抵达目标点时不会过冲，之前在顺风时可能有这种现象，即由于风大不能即使刹车导致冲过目标点。

20250322
由于修复的2306机器存在共振问题，在balance函数里修改了角加速度调节项，之前期望0.2秒匹配期望的角加速度，现在修改为期望0.5秒匹配，这样等于是调弱了。再然后修改了balance的总调节系数，现调节到65，之前是100降到75仍有震荡。现在看起来机身不共振了。这之前一般70左右就不会共振。和硬件有关，和机身刚性有关。每个机器都不同。

20250323
这次机器共振可能和电池下面的减震胶替换为防滑胶带有关，这个胶带薄减震差，共振频率跟以前不一样了。今日测试低处不抖高处抖，这应该和气压控高有关。
低处也抖，也和防滑垫无关

20250324
修复的2306机器共振问题依旧没有解决，怀疑是新换的icm42688和之前的icm42605有一定差异，要么是换用的老电调设置不合理，机器听起来发力不连贯丝滑。恢复平衡函数和控高函数放在2806的机器上测试没有丝毫震动问题，这个机器用的icm42605以及较晚购买的电调。

上午修改balance函数，逻辑不变，只是抽取了主调节系数出来，放在配置表里，以后可以方便配置调节，各调节系数现在先求和再乘以共同的调节系数。

经过以上轻微修改后，两台机器都表现良好，使用相同的参数。2306的机器共振和摇摆都不见了。这实在是很奇怪，先前的共振和摇摆怎么都调整不到位，这次也没怎么改代码，但是就解决了，这很奇怪，不管了，共振的原因不好找。
代码备份，标记为good.

20250326
昨日测试上面标记为good的代码，3级风左右，顶风飞行时，侧倾角度较大，20多度，常有不能保持yaw角的情况，总的飞行路线是直的，但机身指向会在逆风环境下大幅摇摆，许多次摇摆都没事，直到最后一次摇摆超过了100度以上，导致路线弯曲回绕，高度下跌，在回绕后继续飞向目标，由于高度太低所以接管了，但随后发生姿态大幅摇晃以至于平衡失稳，上下颠倒进入保护坠机。
减弱平衡函数里的不对称阻尼项，之前的远离阻尼增加较大，未必能起到期望的作用，因为这引入了很大的不对称性，容易大幅震荡，不能挽救极端情况的侧翻。增强yaw角的调节力度，上次观察到逆风时yaw角摇晃的很大，带来不稳定。

20250327
前天的炸鸡和去年11月的飞丢有相似之处，11月的飞丢先是大顺风飞行，后返回是大逆风飞行，之前一直以为是顺风时速度控制不当，追求飞行效率而忽视了高度控制。现在考虑更可能是返回时逆风飞行的问题。一直以来大逆风飞行稳定性都不好。分析了前天坠机记录，系统在平飞时突然标记了机身翻转，肉眼的观察当时是没有翻转，而是大幅摆动，且发生了退行。就观察而言，当时可能遇到一股突变大风导致一个向后的大加速度产生，使飞机突然减速退行。根据模拟，水平方向的大加速度会影响系统的方向判断，因为系统靠重力加速度的方向去定位垂直方向，在系统本身出现水平加速度时，两个加速度的合成就不再指向垂直方向，这个垂直方向是pitch/roll的基准方向，这样pitch/roll会产生偏差，水平加速度越大偏差越大。
为了避免这个问题，可能需要修改imu里的处理代码，当总加速度远大于重力加速度时，或许需要适度调节pitch/roll.
下午修改了imu里加速度的补偿，分析其偏离重力加速度的程度设置不同的补偿速度，这样可以避免在大风中飞行时遇到的大的水平加速度产生姿态判断误差，之前的算法并不考虑遇到大水平加速度时的影响，那样pitch/roll的偏差会很大，可以达到10度以上，可能会对姿态控制造成极大影响。
然后调整了平衡函数，将线性调节全部改为非线性调节，主要是为了避免在软机架上造成冲击共振，一旦发生共振机器较难控制。


20250328
修改了get_spd_acc_lmt_by_dist里近距离的速度限制，放松了些，这样定点或许更稳定。
在测距控高里，有一个比较气压速度的地方，之前这个气压速度没有换算为标准单位就去和测距速度比较，已经修正了这个问题。这个问题在20250307的标记为稳定的备份里存在，这可能需要被修正。
备份，标记为good.

20250329
今日在大风中测试了，风力估计有5-7级，飞行姿态稳定无大幅晃动，飞行路线是两次50米的五角星，飞行时间大约20分钟，没有显著的危险情况发生，只是飞行路线不能够保持直线，在顺风时基本直线，在侧风逆风时都是大幅弯曲，多有退行现象，但都能够稳定下来完成任务。备份，标记为稳定。查了气象预报，风力4-5级，阵风8-9级，和感觉一致，确实风很大。
轻微修改Pin_to_location里的电流限制下的计算want_hspd1的方法，将大风下的退行处理考虑进去，防范退行下电流的不当限制。

20250331
今日测试显示，飞行路线弧度较大，路线弯曲，风力大约3级，这表示舵向调节力度偏小，之前并没有这个问题，但这次调节了平衡函数，可能受到其影响。另外这次也调节了电流限制，放松了些，所以似乎比以前的速度更快，然后导致刹车比较剧烈，此时有侧风的情况下路线就容易弯曲，如果是刹车比较缓可能更容易保持直线。
修改一，降低进近的速度，之前是sqrt(1.2*dist)改为sqrt(dist)，修改二，舵向调节加强，因roll的不同而减小舵向调节力被削弱。修改三，刹车函数现在摇晃比较大，加强imu的阻尼作用。修改四，经过电流限制调节的want_hspd1要不能比want_hspd大，否则减速阶段有问题，这可能也是今天飞行中的问题，即减速阶段速度太大。这个问题在3/7备份的版本里也存在，want_hspd1可能比want_hspd大，但不会大很多。

20250402
将平衡函数里的主要参数转为可配置参数，写入参数表里方便调节。
今日测试显示，飞行路线弯曲较大，平飞速度控制的不平滑，这很可能是因为平衡函数的参数修改造成的，平衡函数执行姿态指令延迟可能较大，对于其他方面的控制比如速度方向等的控制造成了影响。
pin_to_location里的舵向调节新增考虑方向角的变化率及几个角度的积分，这样可能更稳定。原来只有P调节，现在增加I,D调节。
get_proper_hspd里恢复之前的算法，采用sqrt(1.2*dist)

20250404
不同速度下的倾角限制由之前的基于GPS速度换为指向目标的速度，这可以避免被大风吹到反向飞行时倾角被不合理的限制。
轻微修改掉高的宽容度，高度易受风力影响而误判。现在1.2米以上的掉高才开始限制倾角。

20250406
测试时因参数设置不当，D值由0.6调节为0.2后，起飞后大幅摇摆坠落，肚皮朝上，气压控高立即激活侧翻降落,但立即又退出,记录下cancel upside down smoothlanding，如此反复，导致电机不停转。怀疑是Imu数据处理的改动导致角度计算存在问题，影响了zaxis的判断？具体原因不明确。cancel upside down smoothlanding缺少详细记录，现增加记录zaxis的值。
限制tof控高里的imuvacc加速度到-3.0，3.0, 因有时机身强震无法降落。

20250409
今日测试，2306小机器的平衡参数还是存在一定问题，在自主降落时存在偶发失稳，大幅晃动。2806机器挺稳。
感觉上看是未知原因激发了远离阻尼，而远离阻尼也许不够强，现轻微加强。
近期在修改平衡函数及调参时犯了一个错误，就是将角加速度阻尼降低了10倍，结果参数非常难调，很难找到一个特别稳定的系数组合，今天发现2306小机器依旧在某些情况下会失稳摇摆，然后对比老的系数发现角加速度阻尼低了10倍，将这个系数调高10倍看起来很稳，也没有共振，阻尼实在是很重要的稳定因素。

20250410
基本稳定，当前只在调试舵向调节参数以保持飞行路线笔直。这里不知道为什么，参数比之前的稳定版要大的多，但总感觉路线还没以前直，也许是最近风大，以前测试时风小？
备份。

20250413
将micro_task.roll/pitch由float改为int8_t, 在具体执行时/3.0换算为度数。
之前是遥控器传过来就直接/3.0转为度数, 然后存放为float.

20250414
测试了将micro_task.roll/pitch由float改为int8_t的代码，看起来没问题。
准备增加盲目起飞的处理，无方向起飞后，通过打几次摇杆控制可以判断基本方向，随后可转为GPS模式，在不确定方向时有用。

20250416
这两天主要是增加了盲目起飞后的方向识别代码，目前方向识别基本稳定可靠。备份。

20250417
新增高度调节时目标气压的硬限制，因气压传感器的最低值是30000pa.
MS5611/MS5607的最低量程为1000pa，以后可考虑采用。
MS5611-01BA03  Operating range: 10 to 1200 mbar,

20250418
命令解析里的总路径计算有误，主要出在B命令上，修正。添加长路径飞行提示，并且禁止超长路径的飞行，这主要是防止错误的坐标导致的非预期飞行。

20250506
自4/20离京后在多地测试飞行，表现稳定可靠，标记为稳定版。



